<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro PR's+ (An√°lise Completa)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        
        /* Classes de Expans√£o para o CollapsibleCard */
        .is-expanded {
             max-height: 2000px; 
             opacity: 1;
             overflow: auto; 
             transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        .is-collapsed {
             max-height: 0;
             opacity: 0;
             overflow: hidden;
             transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }
        
        /* Estiliza√ß√£o da Scrollbar para dispositivos que a exibem */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="text-gray-900 selection:bg-indigo-100">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        // √çcones necess√°rios
        import { BarChart2, Plus, Trash2, Pencil, Trophy, Sparkles, Brain, X, Settings, Download, Upload, Flame, LayoutGrid, ChevronDown, RefreshCw, TrendingUp, Hash, Clock, Route, Search, AlertTriangle, ChevronUp } from 'lucide-react';

        // --- CONSTANTES ---
        const GEMINI_API_KEY_DEFAULT = ""; 
        const DEEPSEEK_ENDPOINT = "https://api.deepseek.com/v1/chat/completions";

        // --- UTILIT√ÅRIOS ---
        const getLocalTodayDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const parseDate = (dateStr) => {
            const [y, m, d] = dateStr.split('-');
            return new Date(Date.UTC(y, m - 1, d));
        };
        const isCardio = (group) => group === 'Cardio';

        /**
         * FUN√á√ÉO GEN√âRICA DE FETCH COM EXPONENTIAL BACKOFF
         * Lida com falhas tempor√°rias para maior robustez.
         */
        const robustFetch = async (url, options, maxRetries = 3) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    } else if ((response.status === 429 || response.status >= 500) && i < maxRetries - 1) {
                        // Erro de Rate Limit ou Servidor - Tenta novamente
                        throw new Error("Retryable Error"); 
                    } else {
                        // Erro fatal (ex: Chave inv√°lida, 401/403)
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `Erro HTTP ${response.status} na tentativa ${i + 1}`);
                    }
                } catch (error) {
                    if (error.message === "Retryable Error") {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500; // Backoff + Jitter
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; 
                    }
                    throw error; 
                }
            }
            throw new Error("Falha na chamada √† API ap√≥s v√°rias tentativas.");
        };

        // --- WRAPPERS ESPEC√çFICOS DE API ---

        const callGeminiApi = async (prompt, apiKey) => {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { 
                contents: [{ parts: [{ text: prompt }] }] 
            };
            const response = await robustFetch(apiUrl, {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        };

        const callDeepseekApi = async (prompt, apiKey) => {
            const payload = {
                model: "deepseek-chat", // Modelo padr√£o da DeepSeek
                messages: [{ role: "user", content: prompt }]
            };
            const response = await robustFetch(DEEPSEEK_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}` // Autentica√ß√£o DeepSeek/OpenAI-style
                },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            // A estrutura de resposta da DeepSeek √© diferente
            return data.choices?.[0]?.message?.content;
        };

        /**
         * FUN√á√ÉO UNIFICADA DE CHAMADA DE IA (Gemini -> DeepSeek Fallback)
         */
        const callUnifiedApi = async (prompt, geminiKey, deepseekKey, showMessage) => {
            let geminiError = null;

            // 1. TENTATIVA GEMINI
            if (geminiKey) {
                try {
                    const result = await callGeminiApi(prompt, geminiKey);
                    if (result) return { source: "Gemini", content: result };
                } catch (error) {
                    geminiError = error.message;
                    // Se a chave for a padr√£o do ambiente, ou se houver um erro de rate limit, o fallback √© permitido.
                    console.warn(`Gemini falhou: ${geminiError}. Tentando DeepSeek...`);
                }
            }

            // 2. TENTATIVA DEEPSEEK
            if (deepseekKey) {
                try {
                    const result = await callDeepseekApi(prompt, deepseekKey);
                    if (result) return { source: "DeepSeek", content: result };
                } catch (error) {
                    console.error(`DeepSeek falhou: ${error.message}`);
                    throw new Error(`As APIs falharam. Gemini: [${geminiError || 'N√£o Tentado'}]. DeepSeek: [${error.message}]`);
                }
            }

            // 3. AMBAS FALHARAM OU NENHUMA CHAVE V√ÅLIDA
            if (geminiError) {
                 throw new Error(`Gemini falhou: [${geminiError}]. Nenhuma chave DeepSeek configurada para fallback.`);
            }
            throw new Error("Nenhuma chave API v√°lida (Gemini ou DeepSeek) configurada nas Configura√ß√µes.");
        };


        // --- CAT√ÅLOGO COMPLETO ---
        const EXERCISE_CATALOG = {
            "Peitoral": {
                "Supino Reto": ["Barra Livre", "Halteres", "Smith", "M√°quina Vertical", "M√°quina Horizontal", "Articulado (Hammer)", "Ch√£o (Floor Press)"],
                "Supino Inclinado": ["Barra Livre", "Halteres", "Smith", "M√°quina", "Articulado (Hammer)"],
                "Supino Declinado": ["Barra Livre", "Halteres", "Smith", "M√°quina", "Articulado"],
                "Crucifixo": ["Reto (Halteres)", "Inclinado (Halteres)", "Declinado (Halteres)", "M√°quina (Peck Deck)", "Polia M√©dia (Em p√©)", "Banco Reto (Polia)"],
                "Crossover (Polia)": ["Polia Alta (Foco Inferior)", "Polia Baixa (Foco Superior)", "Polia M√©dia"],
                "Flex√£o de Bra√ßo": ["Padr√£o (Ch√£o)", "P√©s Elevados (Inclinada)", "M√£os Elevadas (Declinada)", "Diamante (Fechada)", "Aberta", "Com Peso"],
                "Paralelas": ["Corpo Livre", "M√°quina (Graviton)", "Com Peso Adicional"],
                "Pullover": ["Halter", "Barra", "Corda (Polia)"]
            },
            "Costas": {
                "Puxada Alta (Polia)": ["Frente (Pegada Aberta Pronada)", "Frente (Pegada Fechada Supinada)", "Tri√¢ngulo (Neutra)", "Barra Romana (Neutra)", "Unilateral", "Articulada"],
                "Remada Curvada": ["Barra (Pronada)", "Barra (Supinada)", "Halteres (Bilateral)", "Smith"],
                "Remada Unilateral": ["Serrote (Halter)", "Kroc Rows", "M√°quina Unilateral", "Polia Baixa"],
                "Remada Baixa (Sentado)": ["Tri√¢ngulo", "Barra Romana", "Barra Reta (Pronada)", "Barra Reta (Supinada)", "Corda"],
                "Remada M√°quina": ["Pegada Aberta (Pronada)", "Pegada Fechada (Neutra)", "Apoiada no Peito (Chest Supported)"],
                "Remada Cavalinho": ["Barra Livre", "M√°quina"],
                "Levantamento Terra": ["Convencional", "Sum√¥", "Meio Terra (Rack Pull)", "Com D√©ficit"],
                "Barra Fixa": ["Pronada (Pull-up)", "Supinada (Chin-up)", "Neutra", "Graviton (Assistida)"],
                "Pullover (Dorsal)": ["Corda (Polia Alta)", "Barra Reta (Polia Alta)", "M√°quina (Pullover)"],
                "Pulldown": ["Corda", "Barra Reta", "Tri√¢ngulo"],
                "Extens√£o Lombar": ["Banco (Hiperextens√£o)", "M√°quina", "Good Morning (Bom dia)"]
            },
            "Ombros": {
                "Desenvolvimento": ["Barra (Militar em P√©)", "Barra (Sentado)", "Halteres (Sentado)", "Halteres (Em P√©)", "Arnold Press", "Smith (Frente)", "Smith (Nuca)", "M√°quina", "Articulado"],
                "Eleva√ß√£o Lateral": ["Halteres (Em P√©)", "Halteres (Sentado)", "Polia (Cabo)", "M√°quina", "Unilateral (Inclinado)"],
                "Eleva√ß√£o Frontal": ["Halteres (Martelo)", "Halteres (Pronada)", "Barra", "Corda (Polia)", "Anilha"],
                "Posterior de Ombro": ["Crucifixo Inverso (Halter)", "Voador Inverso (M√°quina)", "Face Pull (Polia)", "Crucifixo Inverso (Polia)"],
                "Remada Alta": ["Barra", "Polia", "Halteres"],
                "Encolhimento (Trap√©zio)": ["Barra", "Halteres", "Smith", "M√°quina"]
            },
            "Pernas: Quadr√≠ceps": {
                "Agachamento": ["Livre (Barra Costas)", "Frontal (Barra)", "Sum√¥", "Halter (Goblet)", "Zercher", "Safety Bar"],
                "Agachamento M√°quina": ["Smith", "Hack Machine", "V-Squat", "P√™ndulo", "Sissy Squat"],
                "Leg Press": ["45 Graus", "Horizontal", "Vertical", "Unilateral"],
                "Cadeira Extensora": ["Bilateral", "Unilateral"],
                "Passada/Afundo": ["Avan√ßo (Caminhando)", "Afundo Est√°tico (Halter)", "Afundo (Smith)", "Agachamento B√∫lgaro", "Subida no Banco (Step-up)"]
            },
            "Pernas: Adutores": {
                 "Cadeira Adutora": ["Sentado"],
                 "Adu√ß√£o Polia": ["Em P√©"]
            },
            "Pernas: Posteriores": {
                "Mesa Flexora": ["Deitada (Bilateral)", "Deitada (Unilateral)"],
                "Cadeira Flexora": ["Sentada (Bilateral)", "Sentada (Unilateral)"],
                "Flexora em P√©": ["M√°quina", "Caneleira"],
                "Stiff": ["Barra", "Halteres", "Smith"],
                "RDL (Romanian Deadlift)": ["Barra", "Halteres"],
                "Nordic Hamstring": ["Peso do Corpo", "Assistido"]
            },
            "Pernas: Gl√∫teos": {
                "Eleva√ß√£o P√©lvica": ["Barra Livre", "M√°quina", "Smith", "Unilateral", "Halter"],
                "Cadeira Abdutora": ["Tronco Reto", "Tronco Inclinado"],
                "Gl√∫teo Polia (Coice)": ["Perna Estendida", "Perna Flexionada"],
                "Gl√∫teo M√°quina": ["Coice", "Vertical"],
                "Caneleira": ["4 Apoios", "Em P√©"]
            },
            "Panturrilhas": {
                "Em P√©": ["M√°quina", "Smith", "Livre (Degrau/Halter)", "Unilateral"],
                "Sentado": ["Banco (G√™meos)", "M√°quina", "No Leg Press"],
                "Burrinho": ["M√°quina", "Com Parceiro"]
            },
            "Tr√≠ceps": {
                "Tr√≠ceps Polia (Cabo)": ["Corda", "Barra Reta", "Barra V", "Barra W", "Unilateral (Pegada Inversa)", "Unilateral (Pegada Neutra)"],
                "Tr√≠ceps Testa": ["Barra W", "Halteres", "Barra H", "Corda (Polia)"],
                "Tr√≠ceps Franc√™s": ["Unilateral (Halter)", "Bilateral (Halter)", "Corda (Polia)", "Barra W (Sentado)"],
                "Supino Fechado": ["Barra", "Smith"],
                "Mergulho": ["Paralelas", "Banco", "M√°quina (Graviton)"],
                "Coice": ["Halter", "Polia"]
            },
            "B√≠ceps": {
                "Rosca Direta": ["Barra Reta", "Barra W", "Polia Baixa (Barra)", "Polia Baixa (Unilateral)"],
                "Rosca na Polia": ["Unilateral (Polia Baixa)", "Bayeisan Curl (Polia)", "Corda (Martelo Polia)"],
                "Rosca Alternada": ["Halteres (Em p√©)", "Halteres (Banco Inclinado 45¬∫)", "Giro de Punho"],
                "Rosca Martelo": ["Halteres", "Corda (Polia)", "Barra H"],
                "Rosca Scott": ["Barra W", "M√°quina", "Unilateral (Halter)"],
                "Rosca Concentrada": ["Halter", "Polia"],
                "Rosca Aranha": ["Barra W", "Halteres"],
                "Rosca 21": ["Barra W", "Barra Reta"]
            },
            "Antebra√ßo": {
                "Flex√£o de Punho": ["Barra", "Halter", "Polia"],
                "Extens√£o de Punho": ["Barra", "Halter", "Polia"],
                "Rosca Inversa": ["Barra W", "Barra Reta", "Polia"]
            },
            "Abd√¥men / Core": {
                "Reto Abdominal": ["Supra (Ch√£o)", "Supra (M√°quina)", "Crunch (Polia/Corda)", "Banco Declinado"],
                "Infra": ["Eleva√ß√£o de Pernas (Ch√£o)", "Eleva√ß√£o de Pernas (Barra)", "Tesoura"],
                "Obl√≠quos": ["Giro Russo (Russian Twist)", "Flex√£o Lateral de Tronco (Halter)", "Lenhador (Polia)"],
                "Isometria": ["Prancha Frontal", "Prancha Lateral", "Stomach Vacuum", "Roda Abdominal"]
            },
            "Cardio": {
                "M√°quinas": ["Esteira (Caminhada)", "Esteira (Corrida)", "Bike Ergom√©trica", "Bike Spinning", "El√≠ptico", "Escada (Simulador)", "Remo Indoor"],
                "Livre": ["Pular Corda", "Corrida na Rua", "Caminhada", "Polichinelos", "Burpees"]
            }
        };

        // --- SERVI√áO DE STORAGE ---
        const StorageService = {
            KEY_LOGS: 'registro_prs_logs_v2',
            KEY_GEMINI_API: 'registro_prs_api_key', // Renomeado para Gemini
            KEY_DEEPSEEK_API: 'registro_prs_deepseek_api_key', // Novo para DeepSeek
            
            getLogs: () => {
                try {
                    const data = localStorage.getItem(StorageService.KEY_LOGS);
                    return data ? JSON.parse(data).sort((a, b) => b.createdAt - a.createdAt) : [];
                } catch (e) { console.error("Erro ao ler logs", e); return []; }
            },
            saveLog: (log) => {
                const logs = StorageService.getLogs();
                const sanitizedLog = {
                    ...log,
                    weight: log.weight || null,
                    reps: log.reps || null,
                    time: log.time || null,
                    distance: log.distance || null
                };
                const newLogs = [sanitizedLog, ...logs];
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return newLogs;
            },
            updateLog: (updatedLog) => {
                const logs = StorageService.getLogs();
                const index = logs.findIndex(l => l.id === updatedLog.id);
                if (index !== -1) {
                    logs[index] = updatedLog;
                    localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(logs));
                    return logs;
                }
                return logs;
            },
            deleteLog: (id) => { 
                const logs = StorageService.getLogs();
                const newLogs = logs.filter(l => l.id !== id); 
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return newLogs;
            },
            importLogs: (newLogs) => {
                if (!Array.isArray(newLogs)) return false;
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return true;
            },
            // Fun√ß√µes de Gemini Key
            getGeminiKey: () => localStorage.getItem(StorageService.KEY_GEMINI_API) || '',
            setGeminiKey: (key) => localStorage.setItem(StorageService.KEY_GEMINI_API, key),
            // Fun√ß√µes de DeepSeek Key
            getDeepseekKey: () => localStorage.getItem(StorageService.KEY_DEEPSEEK_API) || '',
            setDeepseekKey: (key) => localStorage.setItem(StorageService.KEY_DEEPSEEK_API, key)
        };

        // --- MODAL DE MENSAGENS E CONFIRMA√á√ÉO (Est√°vel) ---
        function MessageModal({ title, message, onConfirm, onClose, type = 'info' }) {
            let bgColor, icon;
            if (type === 'success') {
                bgColor = 'bg-green-600';
                icon = <Trophy className="w-6 h-6 text-white"/>;
            } else if (type === 'error') {
                bgColor = 'bg-red-600';
                icon = <AlertTriangle className="w-6 h-6 text-white"/>;
            } else if (type === 'confirm') {
                bgColor = 'bg-orange-600';
                icon = <Trash2 className="w-6 h-6 text-white"/>;
            } else { // info
                bgColor = 'bg-indigo-600';
                icon = <Sparkles className="w-6 h-6 text-white"/>;
            }

            const handleConfirm = onConfirm || onClose;
            const handleCancel = onClose;

            return (
                <div className="fixed inset-0 bg-black/70 z-[9999] flex items-center justify-center p-4 animate-fade backdrop-blur-sm">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
                        <div className={`mx-auto ${bgColor} p-3 rounded-full w-fit mb-4`}>{icon}</div>
                        <h3 className="font-black text-xl text-gray-800 mb-2">{title}</h3>
                        <p className="text-sm text-gray-600 mb-6 whitespace-pre-wrap">{message}</p>
                        
                        {type === 'confirm' ? (
                            <div className="flex gap-3">
                                <button onClick={handleCancel} className="flex-1 border border-gray-300 text-gray-600 font-bold py-2 rounded-xl hover:bg-gray-50 transition">Cancelar</button>
                                <button onClick={handleConfirm} className="flex-1 bg-red-600 text-white font-bold py-2 rounded-xl hover:bg-red-700 transition">Confirmar</button>
                            </div>
                        ) : (
                            <button onClick={handleCancel} className="w-full bg-indigo-600 text-white font-bold py-2 rounded-xl hover:bg-indigo-700 transition">Entendi</button>
                        )}
                    </div>
                </div>
            );
        }

        // --- COMPONENTE COLAPS√ÅVEL GEN√âRICO ---
        function CollapsibleCard({ title, icon: Icon, iconColor, children, initialCollapsed = true }) {
            const [isCollapsed, setIsCollapsed] = useState(initialCollapsed);
            const contentRef = useRef(null);

            return (
                <div className="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden group">
                    <button 
                        onClick={() => setIsCollapsed(!isCollapsed)}
                        className="w-full p-5 flex justify-between items-center text-left hover:bg-gray-50 transition"
                    >
                        <h3 className="font-bold text-gray-800 flex items-center text-sm uppercase tracking-wider">
                            <Icon className={`w-4 h-4 mr-2 ${iconColor}`} fill="currentColor"/> 
                            {title}
                        </h3>
                        <ChevronDown className={`w-4 h-4 text-gray-500 transition-transform ${isCollapsed ? '' : 'rotate-180'}`} />
                    </button>
                    <div 
                        ref={contentRef}
                        className={isCollapsed ? 'is-collapsed' : 'is-expanded'}
                    >
                        <div className="px-5 pb-5">
                            {children}
                        </div>
                    </div>
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [activeTab, setActiveTab] = useState('metrics'); 
            const [logs, setLogs] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            
            // Gerencia as duas chaves de API
            const [geminiApiKey, setGeminiApiKey] = useState(''); 
            const [deepseekApiKey, setDeepseekApiKey] = useState(''); 
            
            const [modal, setModal] = useState(null); 

            useEffect(() => {
                setLogs(StorageService.getLogs());
                setGeminiApiKey(StorageService.getGeminiKey());
                setDeepseekApiKey(StorageService.getDeepseekKey());
            }, []);
            
            const showMessage = (title, message, type = 'info', onConfirmAction = () => {}, onCloseAction = () => {}) => {
                 setModal({ 
                    title, 
                    message, 
                    type, 
                    onConfirm: () => { onConfirmAction(); setModal(null); }, 
                    onClose: () => { onCloseAction(); setModal(null); } 
                });
            }

            const handleSaveKeys = () => {
                StorageService.setGeminiKey(geminiApiKey);
                StorageService.setDeepseekKey(deepseekApiKey);
                setShowSettings(false);
                showMessage("Configura√ß√£o Salva!", "As chaves API foram atualizadas com sucesso.", "success");
            };

            const handleDelete = (log) => {
                showMessage(
                    "Apagar Registro", 
                    `Tem certeza que deseja apagar o registro de ${log.exercise} (${log.dateString})? Esta a√ß√£o √© irrevers√≠vel.`, 
                    'confirm', 
                    () => setLogs(StorageService.deleteLog(log.id)) 
                );
            };

            const handleUpdate = (updatedLog) => {
                const newLogs = StorageService.updateLog(updatedLog);
                setLogs(newLogs.sort((a, b) => b.createdAt - a.createdAt));
                showMessage("Edi√ß√£o Salva", "O registro foi atualizado com sucesso.", "success");
            };

            const refreshLogs = () => setLogs(StorageService.getLogs());

            // Resolve a chave Gemini (pode ser vazia para usar a chave injetada pelo ambiente)
            const resolveGeminiApiKey = () => geminiApiKey; 
            // Resolve a chave DeepSeek
            const resolveDeepseekApiKey = () => deepseekApiKey; 

            return (
                <div className="min-h-screen pb-24 md:pb-0 font-sans text-gray-800 bg-gray-100 flex flex-col">
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-30 pt-[env(safe-area-inset-top)]">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <div className="bg-indigo-500 p-1.5 rounded-lg shadow-lg shadow-indigo-500/30">
                                    <Trophy className="h-5 w-5 text-yellow-300" fill="#fcd34d" strokeWidth={1.5}/>
                                </div>
                                <h1 className="text-lg font-black tracking-tight italic">REGISTRO <span className="text-indigo-400">PR's+</span></h1>
                            </div>
                            <button onClick={() => setShowSettings(true)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition active:scale-95">
                                <Settings className="w-5 h-5" />
                            </button>
                        </div>
                    </header>

                    {showSettings && (
                        <SettingsModal 
                            geminiApiKey={geminiApiKey} 
                            setGeminiApiKey={setGeminiApiKey} 
                            deepseekApiKey={deepseekApiKey}
                            setDeepseekApiKey={setDeepseekApiKey}
                            onSave={handleSaveKeys} 
                            onClose={() => setShowSettings(false)}
                            logs={logs}
                            onImportSuccess={refreshLogs}
                            showMessage={showMessage}
                        />
                    )}

                    <main className="max-w-4xl mx-auto p-4 flex-grow w-full">
                        {activeTab === 'log' ? (
                            <LoggerSection 
                                onUpdateLogs={(newLogs) => setLogs(newLogs)} 
                                geminiApiKey={resolveGeminiApiKey()} 
                                deepseekApiKey={resolveDeepseekApiKey()}
                                showMessage={showMessage} 
                            />
                        ) : (
                            <MetricsSection 
                                logs={logs} 
                                geminiApiKey={resolveGeminiApiKey()} 
                                deepseekApiKey={resolveDeepseekApiKey()}
                                onDelete={handleDelete} 
                                onUpdate={handleUpdate} 
                                showMessage={showMessage} 
                            />
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 pb-[env(safe-area-inset-bottom)] md:hidden shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-20">
                        <NavBtn icon={BarChart2} label="Dash" active={activeTab === 'metrics'} onClick={() => setActiveTab('metrics')} />
                        <NavBtn icon={Plus} label="Registrar" active={activeTab === 'log'} onClick={() => setActiveTab('log')} />
                    </nav>

                    <div className="hidden md:flex justify-center mt-6 space-x-4 mb-10">
                        <DesktopBtn label="Dashboard / An√°lise" active={activeTab === 'metrics'} onClick={() => setActiveTab('metrics')} />
                        <DesktopBtn label="Registrar PR" active={activeTab === 'log'} onClick={() => setActiveTab('log')} />
                    </div>
                    
                    {modal && <MessageModal {...modal} />}
                </div>
            );
        }

        // --- COMPONENTES DE BOT√ïES ---
        const NavBtn = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center p-2 rounded-xl transition w-full ${active ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:text-gray-600'}`}>
                <Icon className={`w-6 h-6 mb-1 ${active ? 'fill-current' : ''}`} strokeWidth={active ? 2.5 : 2} />
                <span className="text-[10px] font-bold">{label}</span>
            </button>
        );
        const DesktopBtn = ({ label, active, onClick }) => (
            <button onClick={onClick} className={`px-6 py-2 rounded-full font-bold text-sm transition transform hover:scale-105 ${active ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-gray-600 shadow border hover:bg-gray-50'}`}>{label}</button>
        );

        // --- MODAL DE CONFIGURA√á√ïES (ATUALIZADO PARA DUAS CHAVES) ---
        function SettingsModal({ geminiApiKey, setGeminiApiKey, deepseekApiKey, setDeepseekApiKey, onSave, onClose, logs, onImportSuccess, showMessage }) {
            const fileInputRef = useRef(null);
            const isUsingCustomGemini = geminiApiKey && geminiApiKey.trim().length > 10;
            const isUsingDeepseek = deepseekApiKey && deepseekApiKey.trim().length > 10;

            const handleExport = () => {
                const dataStr = JSON.stringify(logs, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_pr_tracker_${getLocalTodayDate()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("Exporta√ß√£o Conclu√≠da", "Seu backup foi baixado como JSON.", "success");
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedLogs = JSON.parse(e.target.result);
                        if (Array.isArray(importedLogs)) {
                             onClose();
                             showMessage("Restaurar Dados", `Encontrados ${importedLogs.length} registros.\n\nISSO SUBSTITUIR√Å SEUS DADOS ATUAIS.\n\nDeseja continuar?`, 'confirm', 
                                 () => {
                                     StorageService.importLogs(importedLogs);
                                     onImportSuccess();
                                     showMessage("Sucesso!", "Dados restaurados com sucesso!", "success");
                                 }
                             );
                        } else {
                             showMessage("Erro", "Arquivo JSON inv√°lido ou corrompido.", "error");
                        }
                    } catch (err) { 
                        showMessage("Erro", "Erro ao processar o arquivo.", "error");
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade backdrop-blur-sm">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold flex items-center text-slate-800"><Settings className="w-5 h-5 mr-2"/> Configura√ß√µes</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100"><X className="w-5 h-5"/></button>
                        </div>
                        
                        <div className="mb-6 bg-indigo-50 p-4 rounded-xl border border-indigo-100 space-y-4">
                            <h4 className="text-xs font-bold text-indigo-600 uppercase mb-2 tracking-wider flex items-center">
                                <Brain className="w-3 h-3 mr-1" /> Configura√ß√£o do Coach IA (Dual-API)
                            </h4>
                            <p className="text-xs text-gray-600">
                                O aplicativo tentar√° usar o **Gemini** primeiro. Se falhar, usar√° o **DeepSeek** como alternativa (DeepSeek tem prioridade se for a √∫nica chave longa inserida).
                            </p>

                            {/* Campo Gemini Key */}
                            <div>
                                <label className="block text-xs text-gray-400 mb-1 font-bold">Chave API Google Gemini (AIzaSy...)</label>
                                <input 
                                    type="password" 
                                    value={geminiApiKey} 
                                    onChange={(e) => setGeminiApiKey(e.target.value)} 
                                    placeholder="Deixe vazio para usar a chave padr√£o..." 
                                    className="w-full p-3 border border-gray-200 rounded-xl mb-1 text-sm font-mono bg-white focus:ring-2 focus:ring-indigo-500 outline-none" 
                                />
                                <div className="text-[10px]">
                                    {isUsingCustomGemini 
                                        ? <span className="text-blue-600 font-bold">‚úÖ Gemini Personalizada em uso</span>
                                        : <span className="text-gray-500 font-bold">üîë Gemini: Usando chave do ambiente (se dispon√≠vel)</span> 
                                    }
                                </div>
                            </div>
                            
                            {/* Campo DeepSeek Key */}
                            <div>
                                <label className="block text-xs text-gray-400 mb-1 font-bold">Chave API DeepSeek (sk-...)</label>
                                <input 
                                    type="password" 
                                    value={deepseekApiKey} 
                                    onChange={(e) => setDeepseekApiKey(e.target.value)} 
                                    placeholder="Chave DeepSeek para fallback..." 
                                    className="w-full p-3 border border-gray-200 rounded-xl mb-1 text-sm font-mono bg-white focus:ring-2 focus:ring-indigo-500 outline-none" 
                                />
                                <div className="text-[10px]">
                                    {isUsingDeepseek
                                        ? <span className="text-emerald-600 font-bold">‚úÖ DeepSeek configurada como Fallback</span>
                                        : <span className="text-red-500 font-bold">‚ùå DeepSeek n√£o configurada</span> 
                                    }
                                </div>
                            </div>

                            <button onClick={onSave} className="w-full bg-indigo-600 text-white font-bold py-2 rounded-xl text-sm hover:bg-indigo-700 active:scale-95 transition">Salvar Configura√ß√µes API</button>
                        </div>

                        <hr className="border-gray-100 my-4" />

                        <div>
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider">Gerenciar Dados</h4>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={handleExport} className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-indigo-300 transition group bg-white">
                                    <Download className="w-6 h-6 text-indigo-500 mb-2 group-hover:scale-110 transition"/>
                                    <span className="text-sm font-bold text-gray-700">Exportar</span>
                                    <span className="text-[10px] text-gray-400">Backup JSON</span>
                                </button>
                                <button onClick={() => fileInputRef.current.click()} className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-orange-300 transition group bg-white">
                                    <Upload className="w-6 h-6 text-orange-500 mb-2 group-hover:scale-110 transition"/>
                                    <span className="text-sm font-bold text-gray-700">Restaurar</span>
                                    <span className="text-[10px] text-gray-400">Ler JSON</span>
                                </button>
                                <input type="file" accept=".json" ref={fileInputRef} style={{display: 'none'}} onChange={handleFileChange} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD (METRICS) ---
        function MetricsSection({ logs, geminiApiKey, deepseekApiKey, onDelete, onUpdate, showMessage }) {
            const [view, setView] = useState('dashboard');
            const [dashboardView, setDashboardView] = useState('strength'); 
            const [showFullRankingStrength, setShowFullRankingStrength] = useState(false);
            const [showFullRankingCardio, setShowFullRankingCardio] = useState(false);
            const [analysis, setAnalysis] = useState('');
            const [loading, setLoading] = useState(false);
            const [editingLog, setEditingLog] = useState(null);
            
            const [searchTerm, setSearchTerm] = useState('');
            const [sortOrder, setSortOrder] = useState('dateDesc'); 

            const strengthLogs = useMemo(() => logs.filter(l => !isCardio(l.muscleGroup)), [logs]);
            const cardioLogs = useMemo(() => logs.filter(l => isCardio(l.muscleGroup)), [logs]);

            // ... (Fun√ß√µes getProgressionStats, getCardioProgressionStats, etc. permanecem as mesmas) ...
            
            const getProgressionStats = (filteredLogs) => {
                const maxWeightByExercise = {};
                filteredLogs.forEach(l => {
                    const key = `${l.exercise} (${l.variation})`;
                    const currentWeight = l.weight || 0;
                    const currentReps = l.reps || 0;

                    if (!maxWeightByExercise[key] || currentWeight > maxWeightByExercise[key].maxW || (currentWeight === maxWeightByExercise[key].maxW && currentReps > maxWeightByExercise[key].maxR)) {
                         maxWeightByExercise[key] = { maxW: currentWeight, maxR: currentReps, group: l.muscleGroup, date: parseDate(l.workoutDate), logId: l.id };
                    }
                });

                const periods = [{ label: '7 Dias', days: 7 }, { label: '15 Dias', days: 15 }, { label: '1 M√™s', days: 30 }];

                const stats = Object.entries(maxWeightByExercise).map(([name, data]) => {
                    const currentPR = data.maxW;
                    const todayUtc = parseDate(getLocalTodayDate()); 
                    
                    const progression = periods.map(period => {
                        const pastDateUtc = new Date(todayUtc.getTime() - (period.days * 86400000)); 
                        
                        let pastMaxW = 0;
                        filteredLogs.forEach(l => {
                            const logKey = `${l.exercise} (${l.variation})`;
                            if (logKey === name) {
                                const logDate = parseDate(l.workoutDate);
                                if (logDate.getTime() < pastDateUtc.getTime()) { 
                                    if ((l.weight || 0) > pastMaxW) {
                                        pastMaxW = (l.weight || 0);
                                    }
                                }
                            }
                        });

                        const diff = currentPR - pastMaxW;
                        const percent = pastMaxW > 0 ? (diff / pastMaxW) * 100 : (diff > 0 ? 100 : 0);

                        return { ...period, diff: parseFloat(diff.toFixed(1)), percent: parseFloat(percent.toFixed(1)) };
                    });

                    return { name, currentPR, group: data.group, progression, reps: data.maxR, date: data.date.toLocaleDateString('pt-BR') };
                }).sort((a, b) => b.currentPR - a.currentPR); 

                return stats;
            };
            
            const allStrengthPrs = useMemo(() => getProgressionStats(strengthLogs), [strengthLogs]);
            const progressionStats = useMemo(() => allStrengthPrs.slice(0, 5), [allStrengthPrs]); 

            const getCardioProgressionStats = (filteredLogs) => {
                const maxMetricByExercise = {};

                filteredLogs.forEach(l => {
                    const key = `${l.exercise} (${l.variation})`;
                    const currentDistance = l.distance || 0;
                    const currentTime = l.time || 0;
                    
                    if (currentDistance > 0 && currentTime > 0) {
                        if (!maxMetricByExercise[key] || 
                            currentDistance > maxMetricByExercise[key].maxD || 
                            (currentDistance === maxMetricByExercise[key].maxD && currentTime < maxMetricByExercise[key].time)) {
                            
                            maxMetricByExercise[key] = { maxD: currentDistance, time: currentTime, group: l.muscleGroup, date: l.workoutDate };
                        }
                    }
                });
                
                const combined = Object.entries(maxMetricByExercise).map(([name, data]) => ({
                    name, 
                    metric: data.maxD, 
                    unit: 'km', 
                    time: data.time, 
                    group: data.group, 
                    date: parseDate(data.date).toLocaleDateString('pt-BR')
                })).sort((a, b) => b.metric - a.metric);

                return combined;
            };
            
            const allCardioPrs = useMemo(() => getCardioProgressionStats(cardioLogs), [cardioLogs]);
            
            const heatmapData = useMemo(() => {
                const days = [];
                const today = new Date();
                const offset = today.getTimezoneOffset() * 60000; 
                
                for (let i = 27; i >= 0; i--) { 
                    const d = new Date(today.getTime() - (i * 86400000) - offset); 
                    const dateStr = d.toISOString().split('T')[0];
                    const count = logs.filter(l => l.workoutDate === dateStr).length;
                    days.push({ date: dateStr, count, dayNum: d.getDate() });
                }
                return days;
            }, [logs]);

            const muscleStats = useMemo(() => {
                const stats = {};
                let total = 0;
                logs.forEach(l => {
                    stats[l.muscleGroup] = (stats[l.muscleGroup] || 0) + 1;
                    total++;
                });
                return Object.entries(stats)
                    .map(([name, count]) => ({ name, count, percent: total ? (count/total)*100 : 0 }))
                    .sort((a,b) => b.count - a.count);
            }, [logs]);

            const sortedAndFilteredLogs = useMemo(() => {
                let filtered = logs.filter(l => 
                    (l.exercise || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (l.variation || '').toLowerCase().includes(searchTerm.toLowerCase())
                );

                return filtered.sort((a, b) => {
                    if (sortOrder === 'dateDesc') return b.createdAt - a.createdAt;
                    if (sortOrder === 'dateAsc') return a.createdAt - b.createdAt;
                    
                    const valA = isCardio(a.muscleGroup) ? (a.distance || 0) / (a.time || 1) : (a.weight || 0) * (a.reps || 0);
                    const valB = isCardio(b.muscleGroup) ? (b.distance || 0) / (b.time || 1) : (b.weight || 0) * (b.reps || 0);
                    
                    if (sortOrder === 'metricDesc') return valB - valA;
                    if (sortOrder === 'metricAsc') return valA - valB;
                    
                    return 0;
                });
            }, [logs, searchTerm, sortOrder]);


            const groupedHistory = useMemo(() => {
                const groups = {};
                sortedAndFilteredLogs.forEach(l => {
                    if(!groups[l.dateString]) groups[l.dateString] = [];
                    groups[l.dateString].push(l);
                });
                return Object.entries(groups);
            }, [sortedAndFilteredLogs]);

            // Fun√ß√£o de An√°lise da IA - AGORA USA O CALL UNIFICADO
            const analyze = async () => {
                if (strengthLogs.length === 0) {
                     setAnalysis("Registre alguns treinos de for√ßa primeiro para que o Coach IA possa analisar seu progresso!");
                     return;
                }

                setLoading(true);
                setAnalysis('');
                try {
                    const history = strengthLogs.slice(0, 30).map(l => `${l.dateString}: ${l.exercise} (${l.weight}kg x ${l.reps})`).join('\n');
                    
                    const prompt = `Aja como um treinador pessoal focado em progress√£o de carga. O hist√≥rico de treino abaixo cont√©m APENAS o Recorde Pessoal (PR) de carga m√°xima/repeti√ß√µes de cada exerc√≠cio por dia, e n√£o todas as s√©ries realizadas. Analise este hist√≥rico de PRs recentes e me d√™ um feedback curto (m√°x 3 frases) e motivador sobre a progress√£o ou consist√™ncia da carga m√°xima. Destaque um ou dois PRs recentes (peso mais alto) se existirem. Hist√≥rico:\n${history}`;
                    
                    const { source, content } = await callUnifiedApi(prompt, geminiApiKey, deepseekApiKey, showMessage);
                    
                    setAnalysis(`[via ${source}] ${content}` || "Erro na an√°lise. Sem resposta.");

                } catch(e) { 
                    console.error("Erro na an√°lise IA:", e);
                    setAnalysis(`Erro na IA: ${e.message}. Verifique suas chaves API nas Configura√ß√µes.`); 
                }
                setLoading(false);
            };

            // Componente de Tabela de Progress√£o de PR (For√ßa)
            const ProgressionTable = ({ stats }) => {
                if (stats.length === 0) return <p className="text-center text-xs text-gray-400 italic py-4">Registre dados de treino de for√ßa para ver a progress√£o.</p>;
                
                return (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Exerc√≠cio (PR)</th>
                                    {['7 Dias', '15 Dias', '1 M√™s'].map(label => (
                                        <th key={label} className="px-2 py-2 text-center text-[10px] font-bold text-gray-500 uppercase tracking-wider">vs {label}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-100">
                                {stats.map((item, index) => (
                                    <tr key={index} className="hover:bg-indigo-50/50 transition">
                                        <td className="px-3 py-3 whitespace-nowrap">
                                            <div className="font-bold text-gray-800 text-xs line-clamp-2">{item.name.split('(')[0].trim()}</div>
                                            <div className="text-xs font-black text-indigo-600">{item.currentPR}<span className="text-[10px] text-gray-400 ml-0.5">kg</span></div>
                                        </td>
                                        {item.progression.map((p, pIndex) => (
                                            <td key={pIndex} className="px-2 py-3 whitespace-nowrap text-center">
                                                <div className={`font-black text-xs ${p.diff > 0 ? 'text-green-600' : p.diff < 0 ? 'text-red-500' : 'text-gray-500'}`}>
                                                    {p.diff > 0 ? `+${p.diff}` : p.diff}kg
                                                </div>
                                                <div className={`text-[10px] font-bold ${p.percent > 0 ? 'text-green-500' : p.percent < 0 ? 'text-red-400' : 'text-gray-400'}`}>
                                                    ({p.percent}%)
                                                </div>
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };

            // Componente de Ranking Global de PRs (For√ßa)
            const StrengthRankingTable = ({ prs, showFullRanking, setShowFullRanking }) => {
                const totalItems = prs.length;
                const topN = 3;
                const itemsToShow = showFullRanking ? prs : prs.slice(0, topN);

                if (totalItems === 0) return <p className="text-center text-xs text-gray-400 italic py-4">Nenhum recorde de for√ßa registrado ainda.</p>;

                return (
                    <>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200 text-sm">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-3 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-10"><Hash className="w-3 h-3 mx-auto"/></th>
                                        <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Exerc√≠cio (Grupo)</th>
                                        <th className="px-3 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">PR M√°ximo</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-100">
                                    {itemsToShow.map((item, index) => (
                                        <tr key={item.name} className={`transition ${index < topN ? 'bg-yellow-50/50' : 'hover:bg-gray-50'}`}>
                                            <td className="px-3 py-3 whitespace-nowrap text-center font-black text-lg text-yellow-600">{index + 1}</td>
                                            <td className="px-3 py-3 whitespace-nowrap">
                                                <div className="font-bold text-gray-800 text-sm line-clamp-1">{item.name}</div>
                                                <div className="text-[10px] text-indigo-500 font-semibold uppercase">{item.group}</div>
                                            </td>
                                            <td className="px-3 py-3 whitespace-nowrap text-center">
                                                <div className="font-black text-indigo-700 text-xl leading-none">{item.currentPR}<span className="text-xs font-normal ml-0.5">kg</span></div>
                                                <div className="text-[10px] text-gray-400 font-bold">{item.reps} reps</div>
                                                <div className="text-[9px] text-gray-400 mt-1">{item.date}</div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        {totalItems > topN && (
                            <button 
                                onClick={() => setShowFullRanking(!showFullRanking)}
                                className="w-full text-center text-xs font-bold mt-4 py-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition flex items-center justify-center space-x-1"
                            >
                                {showFullRanking ? (
                                    <>
                                        <ChevronUp className="w-3 h-3"/> <span>Mostrar Top {topN}</span>
                                    </>
                                ) : (
                                    <>
                                        <ChevronDown className="w-3 h-3"/> <span>Mostrar os outros {totalItems - topN} recordes</span>
                                    </>
                                )}
                            </button>
                        )}
                    </>
                );
            };
            
            // Componente de Ranking de Cardio
            const CardioRankingTable = ({ prs, showFullRanking, setShowFullRanking }) => {
                const totalItems = prs.length;
                const topN = 3;
                const itemsToShow = showFullRanking ? prs : prs.slice(0, topN);

                if (totalItems === 0) return <p className="text-center text-xs text-gray-400 italic py-4">Nenhum recorde de Cardio (Dist√¢ncia) registrado ainda.</p>;

                return (
                    <>
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200 text-sm">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-3 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-10"><Hash className="w-3 h-3 mx-auto"/></th>
                                        <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Atividade</th>
                                        <th className="px-3 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Melhor M√©trica</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-100">
                                    {itemsToShow.map((item, index) => (
                                        <tr key={item.name} className={`transition ${index < topN ? 'bg-emerald-50/50' : 'hover:bg-gray-50'}`}>
                                            <td className="px-3 py-3 whitespace-nowrap text-center font-black text-lg text-emerald-600">{index + 1}</td>
                                            <td className="px-3 py-3 whitespace-nowrap">
                                                <div className="font-bold text-gray-800 text-sm line-clamp-1">{item.name.split('(')[0].trim()}</div>
                                                <div className="text-[10px] text-gray-500 font-semibold uppercase">{item.group}</div>
                                            </td>
                                            <td className="px-3 py-3 whitespace-nowrap text-center">
                                                <div className="font-black text-emerald-700 text-xl leading-none">{item.metric}<span className="text-xs font-normal ml-0.5">km</span></div>
                                                <div className="text-[10px] text-gray-400 font-bold">{item.time} min</div>
                                                <div className="text-[9px] text-gray-400 mt-1">{item.date}</div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        
                        {totalItems > topN && (
                            <button 
                                onClick={() => setShowFullRanking(!showFullRanking)}
                                className="w-full text-center text-xs font-bold mt-4 py-2 bg-emerald-50 text-emerald-600 rounded-xl hover:bg-emerald-100 transition flex items-center justify-center space-x-1"
                            >
                                {showFullRanking ? (
                                    <>
                                        <ChevronUp className="w-3 h-3"/> <span>Mostrar Top {topN}</span>
                                    </>
                                ) : (
                                    <>
                                        <ChevronDown className="w-3 h-3"/> <span>Mostrar os outros {totalItems - topN} recordes</span>
                                    </>
                                )}
                            </button>
                        )}
                    </>
                );
            };


            return (
                <div className="animate-fade space-y-6">
                    <div className="flex bg-gray-200 p-1 rounded-xl">
                        <button onClick={() => setView('dashboard')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${view==='dashboard'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Vis√£o Geral</button>
                        <button onClick={() => setView('history')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${view==='history'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Hist√≥rico</button>
                    </div>

                    {view === 'dashboard' ? (
                        <>
                            {/* 1. Card Coach IA (An√°lise de Treino) - SEMPRE VIS√çVEL NO TOPO */}
                            <div className="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-3xl p-5 text-white shadow-lg relative overflow-hidden">
                                <Brain className="absolute right-0 top-0 w-24 h-24 text-white opacity-10 -mr-6 -mt-6"/>
                                <div className="relative z-10">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold flex items-center"><Sparkles className="w-4 h-4 mr-2 text-yellow-300"/> Coach IA (An√°lise de Treino)</h3>
                                        <button onClick={analyze} disabled={loading} className="text-[10px] bg-white/20 px-3 py-1.5 rounded-full hover:bg-white/30 font-bold transition disabled:opacity-50">
                                            {loading ? "Pensando..." : "Analisar Progresso"}
                                        </button>
                                    </div>
                                    <div className="bg-black/20 p-3 rounded-xl min-h-[60px]">
                                        {analysis ? <div className="text-xs whitespace-pre-wrap leading-relaxed">{analysis}</div> : <p className="text-xs opacity-70 italic">Toque em analisar para receber feedback personalizado sobre seus registros de carga.</p>}
                                    </div>
                                </div>
                            </div>
                            
                            {/* 2. Card de Const√¢ncia (Heatmap) - SEMPRE VIS√çVEL */}
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center text-sm uppercase tracking-wider"><Flame className="w-4 h-4 mr-2 text-orange-500" fill="currentColor"/> Const√¢ncia (√öltimos 28 dias)</h3>
                                <div className="grid grid-cols-7 gap-2">
                                    {heatmapData.map((d, i) => (
                                        <div 
                                            key={i} 
                                            title={d.date}
                                            className={`aspect-square rounded-md flex items-center justify-center text-[10px] font-bold transition-all hover:scale-110 ${d.count > 0 ? 'text-white shadow-md shadow-indigo-200' : 'bg-gray-100 text-gray-300'}`}
                                            style={{
                                                backgroundColor: d.count > 0 ? `rgba(99, 102, 241, ${Math.min(1, d.count * 0.4)})` : undefined, 
                                                borderColor: d.count > 0 ? '#6366F1' : '#E5E7EB'
                                            }}
                                        >
                                            {d.dayNum}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* 3. Card Foco Muscular - SEMPRE VIS√çVEL */}
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center text-sm uppercase tracking-wider"><LayoutGrid className="w-4 h-4 mr-2 text-indigo-500"/> Foco Muscular (Distribui√ß√£o)</h3>
                                <div className="space-y-3">
                                    {muscleStats.slice(0, 5).map((s) => (
                                        <div key={s.name}>
                                            <div className="flex justify-between text-xs font-bold mb-1">
                                                <span className="text-gray-700">{s.name}</span>
                                                <span className="text-indigo-500">{Math.round(s.percent)}%</span>
                                            </div>
                                            <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                                <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{width: `${s.percent}%`}}></div>
                                            </div>
                                        </div>
                                    ))}
                                    {muscleStats.length === 0 && <p className="text-center text-xs text-gray-400">Nenhum dado registrado.</p>}
                                </div>
                            </div>
                            
                            {/* 4. Card de Progress√£o de Carga (FOR√áA - TOP 5) - MINIMIZADO POR PADR√ÉO */}
                            <CollapsibleCard 
                                title="Progress√£o de Carga (For√ßa - Top 5)" 
                                icon={TrendingUp} 
                                iconColor="text-green-500"
                                initialCollapsed={true}
                            >
                                <ProgressionTable stats={progressionStats} />
                            </CollapsibleCard>

                            {/* 5. Ranking de Recordes - TOP 3 VIS√çVEL, RESTANTE EXPANS√çVEL */}
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center text-sm uppercase tracking-wider"><Trophy className="w-4 h-4 mr-2 text-yellow-500" fill="currentColor"/> Ranking de Recordes (Top 3)</h3>

                                <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                                    <button onClick={() => setDashboardView('strength')} className={`flex-1 py-1.5 rounded-md text-sm font-bold transition ${dashboardView==='strength'?'bg-indigo-50 shadow text-indigo-600':'text-gray-500'}`}>For√ßa (Peso)</button>
                                    <button onClick={() => setDashboardView('cardio')} className={`flex-1 py-1.5 rounded-md text-sm font-bold transition ${dashboardView==='cardio'?'bg-emerald-50 shadow text-emerald-600':'text-gray-500'}`}>Cardio (Dist/Tempo)</button>
                                </div>

                                {dashboardView === 'strength' ? (
                                    <StrengthRankingTable 
                                        prs={allStrengthPrs} 
                                        showFullRanking={showFullRankingStrength} 
                                        setShowFullRanking={setShowFullRankingStrength}
                                    />
                                ) : (
                                    <CardioRankingTable 
                                        prs={allCardioPrs} 
                                        showFullRanking={showFullRankingCardio} 
                                        setShowFullRanking={setShowFullRankingCardio}
                                    />
                                )}
                            </div>
                        </>
                    ) : (
                        // Hist√≥rico Detalhado (Com Filtros e Ordena√ß√£o)
                        <div className="space-y-6 pb-10">
                            <div className="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 space-y-3">
                                <div className="relative">
                                    <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/>
                                    <input 
                                        type="text" 
                                        placeholder="Filtrar por exerc√≠cio ou varia√ß√£o..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full p-2 pl-9 border border-gray-200 rounded-xl text-sm outline-none focus:ring-1 focus:ring-indigo-300"
                                    />
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-gray-500 font-medium">Ordenar por:</span>
                                    <select 
                                        value={sortOrder}
                                        onChange={(e) => setSortOrder(e.target.value)}
                                        className="p-1.5 border border-gray-200 rounded-lg text-sm bg-white font-bold outline-none"
                                    >
                                        <option value="dateDesc">Mais Recente</option>
                                        <option value="dateAsc">Mais Antigo</option>
                                        <option value="metricDesc">Maior M√©trica (Carga/Velocidade)</option>
                                        <option value="metricAsc">Menor M√©trica</option>
                                    </select>
                                </div>
                            </div>

                            {groupedHistory.map(([date, items]) => (
                                <div key={date} className="relative pl-6 border-l-2 border-indigo-100">
                                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-indigo-500 border-4 border-white shadow-sm"></div>
                                    <h3 className="font-bold text-gray-800 mb-4 text-lg">{date}</h3>
                                    <div className="space-y-3">
                                        {items.map(log => (
                                            <div key={log.id} className="bg-white p-3.5 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group active:scale-[0.99] transition">
                                                <div className="flex-1 pr-2">
                                                    <div className="font-bold text-gray-700 text-sm">{log.exercise}</div>
                                                    <div className="text-xs text-gray-400 line-clamp-1">{log.variation}</div>
                                                </div>
                                                <div className="flex items-center space-x-3">
                                                    <div className="text-right">
                                                        {isCardio(log.muscleGroup) ? (
                                                            <>
                                                                <div className="font-bold text-emerald-600 text-base">{log.time || 0}<span className="text-xs font-normal ml-0.5">min</span></div>
                                                                <div className="text-[10px] text-gray-400">{log.distance || 0} km</div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div className="font-bold text-indigo-600 text-base">{log.weight || 0}kg</div>
                                                                <div className="text-[10px] text-gray-400">{log.reps || 0} reps</div>
                                                            </>
                                                        )}
                                                    </div>
                                                    <div className="flex flex-col space-y-1">
                                                        <button onClick={()=>setEditingLog(log)} className="p-1.5 bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-100"><Pencil className="w-3 h-3"/></button>
                                                        <button onClick={()=>onDelete(log)} className="p-1.5 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><Trash2 className="w-3 h-3"/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            {groupedHistory.length === 0 && <div className="text-center text-gray-400 py-10 italic">Nenhum treino encontrado com o filtro atual.</div>}
                        </div>
                    )}
                    {editingLog && (
                        <EditLogModal log={editingLog} onClose={() => setEditingLog(null)} onSave={(updatedLog) => { onUpdate(updatedLog); setEditingLog(null); }} />
                    )}
                </div>
            );
        }

        // --- EDIT MODAL (Est√°vel) ---
        function EditLogModal({ log, onClose, onSave }) {
            const [weight, setWeight] = useState(log.weight || '');
            const [reps, setReps] = useState(log.reps || '');
            const [time, setTime] = useState(log.time || '');
            const [distance, setDistance] = useState(log.distance || '');

            const [date, setDate] = useState(log.workoutDate);
            const [group, setGroup] = useState(log.muscleGroup);
            const [type, setType] = useState(log.exercise);
            const [variation, setVariation] = useState(log.variation);

            const isNewCardio = isCardio(group);

            useEffect(() => {
                if (group && EXERCISE_CATALOG[group] && !EXERCISE_CATALOG[group][type]) { 
                    setType(''); 
                    setVariation('');
                }
            }, [group]);

            useEffect(() => {
                 if (group && type && EXERCISE_CATALOG[group] && EXERCISE_CATALOG[group][type] && !EXERCISE_CATALOG[group][type].includes(variation)) {
                    setVariation('');
                }
            }, [type]);

            const handleSave = () => {
                const [y, m, d] = date.split('-');
                let updatedMetrics = {};

                if (isNewCardio) {
                    updatedMetrics = { 
                        weight: null, 
                        reps: null, 
                        time: parseFloat(time) || 0, 
                        distance: parseFloat(distance) || 0 
                    };
                } else {
                    updatedMetrics = { 
                        weight: parseFloat(weight) || 0, 
                        reps: parseInt(reps) || 0, 
                        time: null, 
                        distance: null 
                    };
                }
                
                onSave({
                    ...log, 
                    ...updatedMetrics,
                    workoutDate: date, 
                    dateString: `${d}/${m}/${y}`, 
                    muscleGroup: group, 
                    exercise: type, 
                    variation: variation
                });
            };

            const exerciseOptions = (group && EXERCISE_CATALOG[group]) ? Object.keys(EXERCISE_CATALOG[group]) : [];
            const variationOptions = (group && type && EXERCISE_CATALOG[group] && EXERCISE_CATALOG[group][type]) ? EXERCISE_CATALOG[group][type] : [];

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade backdrop-blur-sm">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl relative">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold flex items-center text-indigo-600"><Pencil className="w-5 h-5 mr-2"/> Editar Registro</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100"><X className="w-5 h-5 text-gray-400"/></button>
                        </div>
                        
                        <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-1">
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase">Data</label>
                                <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-gray-50 p-3 rounded-xl font-bold outline-none text-gray-700"/>
                            </div>
                            
                            <Select 
                                label="Grupo" 
                                value={group} 
                                onChange={e=>{setGroup(e.target.value); setType(''); setVariation('');}} 
                                options={Object.keys(EXERCISE_CATALOG)} 
                            />
                            
                            <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Exerc√≠cio</label>
                                <select value={type} onChange={e=>setType(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                                    <option value="" disabled>Selecione...</option>
                                    {!exerciseOptions.includes(type) && type && <option value={type}>{type} (Arquivo)</option>} 
                                    {exerciseOptions.sort().map(o=><option key={o} value={o}>{o}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>

                            <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Varia√ß√£o</label>
                                <select value={variation} onChange={e=>setVariation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-sm text-gray-700">
                                    <option value="" disabled>Selecione...</option>
                                    {!variationOptions.includes(variation) && variation && <option value={variation}>{variation} (Arquivo)</option>}
                                    {variationOptions.map(v=><option key={v} value={v}>{v}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                {isNewCardio ? (
                                    <>
                                        <Input label="Tempo (min)" type="number" value={time} onChange={e=>setTime(e.target.value)} icon={Clock} />
                                        <Input label="Dist√¢ncia (km)" type="number" value={distance} onChange={e=>setDistance(e.target.value)} step="0.1" icon={Route} />
                                    </>
                                ) : (
                                    <>
                                        <Input label="Carga (kg)" type="number" value={weight} onChange={e=>setWeight(e.target.value)} />
                                        <Input label="Reps" type="number" value={reps} onChange={e=>setReps(e.target.value)} />
                                    </>
                                )}
                            </div>
                        </div>

                        <button onClick={handleSave} className="w-full mt-6 py-3 bg-indigo-600 font-bold rounded-xl text-white shadow-lg shadow-indigo-200 active:scale-95 transition">Salvar Altera√ß√µes</button>
                    </div>
                </div>
            );
        }

        // --- LOGGER (REGISTRO) (ATUALIZADO PARA CALL UNIFICADO) ---
        function LoggerSection({ onUpdateLogs, geminiApiKey, deepseekApiKey, showMessage }) {
            const [date, setDate] = useState(getLocalTodayDate());
            const [group, setGroup] = useState('');
            const [type, setType] = useState('');
            const [variation, setVariation] = useState('');
            
            const [weight, setWeight] = useState('');
            const [reps, setReps] = useState('');
            const [time, setTime] = useState('');
            const [distance, setDistance] = useState('');

            const [showTips, setShowTips] = useState(false);
            const [tipLoading, setTipLoading] = useState(false);
            const [tipContent, setTipContent] = useState('');
            const [altContent, setAltContent] = useState('');

            const isCurrentCardio = isCardio(group);

            useEffect(() => { setType(''); setVariation(''); setTipContent(''); setAltContent(''); setShowTips(false); }, [group]);
            useEffect(() => { 
                if(group && type && EXERCISE_CATALOG[group] && EXERCISE_CATALOG[group][type]) {
                    setVariation(EXERCISE_CATALOG[group][type][0] || '');
                } else {
                    setVariation('');
                }
                setTipContent(''); setAltContent(''); setShowTips(false);
            }, [type]);
            useEffect(() => { setTipContent(''); setAltContent(''); setShowTips(false); }, [variation]);


            const fetchTips = async () => { 
                if(isCurrentCardio) { setTipContent("Dicas de execu√ß√£o n√£o se aplicam a Cardio da mesma forma. Registre apenas a performance!"); setAltContent(''); setShowTips(true); return; }

                setShowTips(true);
                setAltContent(''); 
                if(tipContent && !tipLoading) return; 

                setTipLoading(true);
                try {
                    const prompt = `Explique de forma resumida e direta (em bullet points) a forma correta de executar o exerc√≠cio: ${type} (${variation}). D√™ 2 dicas de seguran√ßa cruciais para este movimento.`;
                    const { source, content } = await callUnifiedApi(prompt, geminiApiKey, deepseekApiKey, showMessage);
                    setTipContent(`[via ${source}] ${content}` || "Sem resposta da IA.");
                } catch(e) { 
                    setTipContent(`Erro ao consultar IA: ${e.message}. Verifique suas chaves.`); 
                }
                setTipLoading(false);
            };

            const fetchAlternative = async () => { 
                if(isCurrentCardio) { setAltContent("Alternativas n√£o s√£o fornecidas para Cardio. Escolha na lista ou registre a performance!"); setTipContent(''); setShowTips(true); return; }

                setShowTips(true);
                setTipContent('');
                if(altContent && !tipLoading) return;

                setTipLoading(true);
                try {
                    const prompt = `Sugira uma alternativa biomecanicamente similar para o exerc√≠cio ${type} (${variation}) que possa ser feita em casa ou com equipamentos simples. Seja direto e explique o foco muscular.`;
                    const { source, content } = await callUnifiedApi(prompt, geminiApiKey, deepseekApiKey, showMessage);
                    setAltContent(`[via ${source}] ${content}` || "Sem resposta da IA.");
                } catch(e) { 
                    setAltContent(`Erro ao consultar IA: ${e.message}. Verifique suas chaves.`); 
                }
                setTipLoading(false);
            };


            const handleSave = (e) => {
                e.preventDefault();
                let logData = {};
                let isValid = false;

                if (isCurrentCardio) {
                    isValid = (variation && (parseFloat(time) > 0 || parseFloat(distance) > 0));
                    logData = { weight: null, reps: null, time: parseFloat(time) || 0, distance: parseFloat(distance) || 0 };
                } else {
                    isValid = (variation && parseFloat(weight) > 0 && parseInt(reps) > 0);
                    logData = { weight: parseFloat(weight) || 0, reps: parseInt(reps) || 0, time: null, distance: null };
                }

                if (!isValid) {
                    showMessage("Campos Inv√°lidos", "Preencha todos os campos obrigat√≥rios (Carga/Reps ou Tempo/Dist√¢ncia) e selecione o exerc√≠cio/varia√ß√£o.", "error");
                    return;
                }

                const [y, m, d] = date.split('-');
                const log = {
                    id: Date.now(), 
                    muscleGroup: group, exercise: type, variation, 
                    workoutDate: date, dateString: `${d}/${m}/${y}`, createdAt: Date.now(),
                    ...logData
                };
                onUpdateLogs(StorageService.saveLog(log));
                
                setWeight(''); setReps(''); setTime(''); setDistance('');
                showMessage("Registro Salvo!", `${isCurrentCardio ? 'Cardio' : 'S√©rie'} registrada com sucesso.`, "success");
            };

            const exerciseOptions = (group && EXERCISE_CATALOG[group]) ? Object.keys(EXERCISE_CATALOG[group]) : [];
            const variationOptions = (group && type && EXERCISE_CATALOG[group]?.[type]) ? EXERCISE_CATALOG[group][type] : [];

            return (
                <div className="animate-fade bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center"><Plus className="w-5 h-5 mr-2 text-indigo-500"/> Novo Registro</h2>
                    <form onSubmit={handleSave} className="space-y-4">
                        <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Data do Treino</label>
                            <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-transparent font-bold text-gray-800 outline-none mt-1"/>
                        </div>
                        
                        <Select label="Grupo Muscular" value={group} onChange={e=>setGroup(e.target.value)} options={Object.keys(EXERCISE_CATALOG)} />
                        
                        {group && exerciseOptions.length > 0 && (
                            <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Exerc√≠cio</label>
                                <select value={type} onChange={e=>setType(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                                    <option value="" disabled>Selecione...</option>
                                    {exerciseOptions.sort().map(o=><option key={o} value={o}>{o}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>
                        )}
                        
                        {type && variationOptions.length > 0 && (
                             <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Varia√ß√£o</label>
                                <select value={variation} onChange={e=>setVariation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                                    {variationOptions.map(v=><option key={v} value={v}>{v}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>
                        )}

                        {/* BOT√ïES DE IA (S√≥ se aplicam a treino de for√ßa) */}
                        {type && variation && !isCurrentCardio && (
                            <div className="mt-2">
                                <div className="flex gap-3">
                                    <button type="button" onClick={fetchTips} className="text-xs flex items-center text-indigo-500 font-bold hover:text-indigo-700 transition bg-indigo-50 px-2 py-1 rounded-lg">
                                        <Sparkles className="w-3 h-3 mr-1" /> Como fazer?
                                    </button>
                                    <button type="button" onClick={fetchAlternative} className="text-xs flex items-center text-emerald-600 font-bold hover:text-emerald-800 transition bg-emerald-50 px-2 py-1 rounded-lg">
                                        <RefreshCw className="w-3 h-3 mr-1" /> Substituir (IA)
                                    </button>
                                </div>
                                {showTips && (
                                    <div className="mt-2 p-3 bg-white rounded-xl text-xs text-gray-700 border border-gray-200 leading-relaxed animate-fade shadow-sm">
                                        {tipLoading ? 
                                            <div className="flex items-center space-x-2 text-indigo-500">
                                                <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                <span>Consultando coach...</span>
                                            </div>
                                            : 
                                            <div className="whitespace-pre-wrap">
                                                {tipContent && <><span className="font-bold text-indigo-600 block mb-1">Dicas de Execu√ß√£o:</span>{tipContent}</>}
                                                {altContent && <><span className="font-bold text-emerald-600 block mb-1">Alternativa Sugerida:</span>{altContent}</>}
                                            </div>
                                        }
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Renderiza√ß√£o Condicional de M√©tricas */}
                        <div className="grid grid-cols-2 gap-3 pt-2">
                            {isCurrentCardio ? (
                                <>
                                    <Input label="Tempo (min)" type="number" value={time} onChange={e=>setTime(e.target.value)} icon={Clock} />
                                    <Input label="Dist√¢ncia (km)" type="number" value={distance} onChange={e=>setDistance(e.target.value)} step="0.1" icon={Route} />
                                </>
                            ) : (
                                <>
                                    <Input label="Carga (kg)" type="number" value={weight} onChange={e=>setWeight(e.target.value)} />
                                    <Input label="Reps" type="number" value={reps} onChange={e=>setReps(e.target.value)} />
                                </>
                            )}
                        </div>
                        <button disabled={!variation || (isCurrentCardio ? (!time && !distance) : (!weight || !reps))} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 disabled:opacity-50 disabled:shadow-none active:scale-95 transition mt-4">
                            CONFIRMAR S√âRIE
                        </button>
                    </form>
                </div>
            );
        }
        
        // --- COMPONENTES AUXILIARES ---
        const Select = ({ label, value, onChange, options }) => (
            <div className="relative">
                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">{label}</label>
                <select value={value} onChange={onChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                    <option value="" disabled>Selecione...</option>
                    {options.sort().map(o=><option key={o} value={o}>{o}</option>)}
                </select>
                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
            </div>
        );
        const Input = ({ label, icon: Icon, ...props }) => (
            <div>
                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">{label}</label>
                <div className="relative">
                    {Icon && <Icon className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/>}
                    <input {...props} className={`w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-center font-bold text-lg outline-none focus:ring-2 focus:ring-indigo-200 transition text-gray-800 ${Icon ? 'pl-8 pr-3' : 'px-3'}`} />
                </div>
            </div>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

