<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro PR's+ (Backup)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        .animate-slide { animation: slideUp 0.4s ease-out; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="text-gray-900 selection:bg-indigo-100">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Activity, Dumbbell, BarChart2, Plus, Calendar, Trash2, ChevronDown, ChevronUp, Trophy, Sparkles, Brain, X, Filter, Clock, Lightbulb, Map, Zap, Settings, Save, AlertTriangle, Flame, LayoutGrid, List, Pencil, Download, Upload, FileJson } from 'lucide-react';

        // --- CHAVE DA API PRÉ-CONFIGURADA ---
        const DEFAULT_API_KEY = "AIzaSyCaQxxmiVj9cDgeEGEXROj0GCgrJNRf768";

        // --- CATÁLOGO COMPLETO ---
        const EXERCISE_CATALOG = {
            "Peitoral": {
                "Supino": ["Reto (Barra)", "Reto (Halteres)", "Reto (Smith)", "Reto (Máquina)", "Reto (Articulado)", "Inclinado (Barra)", "Inclinado (Halteres)", "Inclinado (Smith)", "Inclinado (Máquina)", "Inclinado (Articulado)", "Declinado (Barra)", "Declinado (Halteres)", "Declinado (Máquina)"],
                "Crucifixo": ["Reto (Halteres)", "Inclinado (Halteres)", "Declinado (Halteres)", "Máquina (Voador/Peck Deck)", "Inverso (Peck Deck)"],
                "Crossover / Polia": ["Polia Alta (Para baixo)", "Polia Média (Meio peito)", "Polia Baixa (Para cima)"],
                "Peso do Corpo": ["Flexão de Braço (Padrão)", "Flexão Diamante", "Flexão Declinada", "Paralelas (Foco Peito)"],
                "Pullover": ["Halter", "Barra", "Corda (Polia)"]
            },
            "Costas": {
                "Puxada (Polia Alta)": ["Frente (Aberta/Pronada)", "Frente (Fechada/Supinada)", "Frente (Triângulo/Neutra)", "Atrás (Nuca)", "Articulada"],
                "Remada": ["Curvada (Barra Pronada)", "Curvada (Barra Supinada)", "Cavalinho (Barra T)", "Unilateral (Serrote)", "Baixa (Triângulo)", "Baixa (Corda)", "Máquina Fechada", "Máquina Aberta", "Apoiada no Banco"],
                "Levantamento Terra": ["Convencional", "Sumô", "RDL (Romanian)", "Stiff", "Rack Pull"],
                "Extensão de Tronco": ["Hiperextensão (Banco)", "Good Morning (Bom dia)"],
                "Pulldown": ["Barra Reta", "Corda", "Triângulo"],
                "Barra Fixa": ["Pronada (Aberta)", "Supinada (Fechada)", "Neutra", "Graviton (Assistida)"]
            },
            "Pernas (Quadríceps)": {
                "Agachamento": ["Livre (Barra Costas)", "Frontal (Barra)", "Sumô", "Halter (Goblet)", "Smith", "Hack Machine", "V-Squat", "Pêndulo"],
                "Leg Press": ["45 Graus", "Horizontal", "Vertical", "Unilateral"],
                "Extensão de Joelho": ["Cadeira Extensora", "Extensora Unilateral"],
                "Afundo / Avanço": ["Avanço (Passada)", "Afundo Estático (Halter)", "Afundo (Smith)", "Búlgaro"]
            },
            "Pernas (Posterior/Glúteo)": {
                "Flexão de Joelho": ["Mesa Flexora", "Cadeira Flexora", "Flexora em Pé", "Nordic Hamstring"],
                "Elevação Pélvica": ["Barra Livre", "Máquina", "Smith", "Unilateral"],
                "Glúteo Isolado": ["Coice (Polia)", "Coice (Máquina)", "Abdução de Quadril (Cadeira)", "Caneleira (4 Apoios)"]
            },
            "Panturrilhas": {
                "Em Pé": ["Máquina", "Smith", "Livre (Degrau)", "Burrinho"],
                "Sentado": ["Banco (Sóleo)", "Leg Press"]
            },
            "Ombros": {
                "Desenvolvimento": ["Militar (Barra em pé)", "Sentado (Barra)", "Sentado (Halteres)", "Máquina", "Arnold Press", "Smith"],
                "Elevação Lateral": ["Halteres", "Polia (Cabo)", "Máquina", "Sentado"],
                "Elevação Frontal": ["Halteres (Martelo)", "Halteres (Pronada)", "Barra", "Corda (Polia)", "Anilha"],
                "Posterior de Ombro": ["Crucifixo Inverso (Halter)", "Voador Inverso (Máquina)", "Face Pull (Corda)"],
                "Trapézio": ["Encolhimento (Halteres)", "Encolhimento (Barra)", "Encolhimento (Smith)", "Remada Alta"]
            },
            "Tríceps": {
                "Polia (Cabo)": ["Corda", "Barra Reta", "Barra V", "Unilateral (Inverso)"],
                "Testa": ["Barra W", "Halteres", "Corda (Polia)"],
                "Francês": ["Unilateral (Halter)", "Bilateral (Halter)", "Corda (Polia)"],
                "Mergulho/Supino": ["Paralelas", "Banco", "Supino Fechado", "Máquina"],
                "Coice": ["Halter", "Polia"]
            },
            "Bíceps": {
                "Rosca Direta": ["Barra Reta", "Barra W", "Polia Baixa"],
                "Rosca Alternada": ["Halteres (Em pé)", "Halteres (Banco Inclinado)", "Giro de Punho"],
                "Rosca Martelo": ["Halteres", "Corda (Polia)", "Barra H"],
                "Rosca Scott": ["Barra W", "Máquina", "Unilateral (Halter)"],
                "Rosca Concentrada": ["Halter"]
            },
            "Antebraço": {
                "Flexão de Punho": ["Barra", "Halter"],
                "Extensão de Punho": ["Barra", "Halter"],
                "Rosca Inversa": ["Barra", "Polia"]
            },
            "Abdômen / Core": {
                "Reto Abdominal": ["Supra (Chão)", "Supra (Máquina)", "Crunch (Polia/Corda)", "Declined Bench"],
                "Infra": ["Elevação de Pernas (Chão)", "Elevação de Pernas (Barra)", "Tesoura"],
                "Isometria": ["Prancha Frontal", "Prancha Lateral", "Stomach Vacuum"],
                "Oblíquos": ["Russo (Russian Twist)", "Flexão Lateral de Tronco"]
            },
            "Cardio": {
                "Máquinas": ["Esteira", "Bike Ergométrica", "Elíptico", "Escada", "Remo Indoor"],
                "Livre": ["Pular Corda", "Corrida", "Caminhada"]
            }
        };

        const StorageService = {
            KEY_LOGS: 'registro_prs_logs',
            KEY_API: 'registro_prs_api_key',
            getLogs: () => {
                const data = localStorage.getItem(StorageService.KEY_LOGS);
                return data ? JSON.parse(data).sort((a, b) => b.createdAt - a.createdAt) : [];
            },
            saveLog: (log) => {
                const logs = StorageService.getLogs();
                const newLogs = [log, ...logs];
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return newLogs;
            },
            updateLog: (updatedLog) => {
                const logs = StorageService.getLogs();
                const index = logs.findIndex(l => l.id === updatedLog.id);
                if (index !== -1) {
                    logs[index] = updatedLog;
                    localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(logs));
                    return logs;
                }
                return logs;
            },
            deleteLog: (timestamp) => {
                const logs = StorageService.getLogs();
                const newLogs = logs.filter(l => l.createdAt !== timestamp);
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return newLogs;
            },
            // Função para importar dados brutos (substituir tudo)
            importLogs: (newLogs) => {
                if (!Array.isArray(newLogs)) return false;
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return true;
            },
            getApiKey: () => {
                return localStorage.getItem(StorageService.KEY_API) || DEFAULT_API_KEY;
            },
            setApiKey: (key) => localStorage.setItem(StorageService.KEY_API, key)
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [activeTab, setActiveTab] = useState('metrics');
            const [logs, setLogs] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [apiKey, setApiKey] = useState('');

            useEffect(() => {
                setLogs(StorageService.getLogs());
                setApiKey(StorageService.getApiKey());
            }, []);

            const handleSaveKey = () => {
                StorageService.setApiKey(apiKey);
                setShowSettings(false);
                alert("Configuração Salva!");
            };

            const handleDelete = (timestamp) => {
                if(confirm("Apagar este registro?")) setLogs(StorageService.deleteLog(timestamp));
            };

            const handleUpdate = (updatedLog) => {
                const newLogs = StorageService.updateLog(updatedLog);
                setLogs(newLogs.sort((a, b) => b.createdAt - a.createdAt));
            };

            // Função para recarregar logs após importação
            const refreshLogs = () => {
                setLogs(StorageService.getLogs());
            };

            return (
                <div className="min-h-screen pb-24 md:pb-0 font-sans text-gray-800 bg-gray-100">
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-30">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <div className="bg-indigo-500 p-1.5 rounded-lg shadow-lg shadow-indigo-500/30">
                                    <Trophy className="h-5 w-5 text-yellow-300" fill="#fcd34d" strokeWidth={1.5}/>
                                </div>
                                <h1 className="text-lg font-black tracking-tight italic">REGISTRO <span className="text-indigo-400">PR's+</span></h1>
                            </div>
                            <button onClick={() => setShowSettings(true)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition">
                                <Settings className="w-5 h-5" />
                            </button>
                        </div>
                    </header>

                    {showSettings && (
                        <SettingsModal 
                            apiKey={apiKey} 
                            setApiKey={setApiKey} 
                            onSave={handleSaveKey} 
                            onClose={() => setShowSettings(false)}
                            logs={logs}
                            onImportSuccess={refreshLogs}
                        />
                    )}

                    <main className="max-w-4xl mx-auto p-4">
                        {activeTab === 'log' ? (
                            <LoggerSection onUpdateLogs={(newLogs) => setLogs(newLogs)} apiKey={apiKey} onRequireKey={() => setShowSettings(true)} />
                        ) : activeTab === 'planner' ? (
                            <PlannerSection apiKey={apiKey} onRequireKey={() => setShowSettings(true)} />
                        ) : (
                            <MetricsSection logs={logs} apiKey={apiKey} onDelete={handleDelete} onUpdate={handleUpdate} onRequireKey={() => setShowSettings(true)} />
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 pb-safe-bottom md:hidden shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-20">
                        <NavBtn icon={BarChart2} label="Dashboard" active={activeTab === 'metrics'} onClick={() => setActiveTab('metrics')} />
                        <NavBtn icon={Plus} label="Registrar" active={activeTab === 'log'} onClick={() => setActiveTab('log')} />
                        <NavBtn icon={Map} label="Planejar" active={activeTab === 'planner'} onClick={() => setActiveTab('planner')} />
                    </nav>

                    <div className="hidden md:flex justify-center mt-6 space-x-4">
                        <DesktopBtn label="Dashboard Visual" active={activeTab === 'metrics'} onClick={() => setActiveTab('metrics')} />
                        <DesktopBtn label="Registrar PR" active={activeTab === 'log'} onClick={() => setActiveTab('log')} />
                        <DesktopBtn label="Planejador IA" active={activeTab === 'planner'} onClick={() => setActiveTab('planner')} />
                    </div>
                </div>
            );
        }

        const NavBtn = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center p-2 rounded-xl transition ${active ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:text-gray-600'}`}>
                <Icon className={`w-6 h-6 mb-1 ${active ? 'fill-current' : ''}`} strokeWidth={active ? 2.5 : 2} />
                <span className="text-[10px] font-bold">{label}</span>
            </button>
        );
        const DesktopBtn = ({ label, active, onClick }) => (
            <button onClick={onClick} className={`px-6 py-2 rounded-full font-bold text-sm transition transform hover:scale-105 ${active ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-gray-600 shadow border hover:bg-gray-50'}`}>{label}</button>
        );

        // --- MODAL DE CONFIGURAÇÕES (AGORA COM BACKUP) ---
        function SettingsModal({ apiKey, setApiKey, onSave, onClose, logs, onImportSuccess }) {
            const fileInputRef = useRef(null);

            const handleExport = () => {
                const dataStr = JSON.stringify(logs, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_pr_tracker_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportClick = () => {
                fileInputRef.current.click();
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedLogs = JSON.parse(e.target.result);
                        if (Array.isArray(importedLogs)) {
                            if (confirm(`Encontrados ${importedLogs.length} registros no arquivo.\n\nISSO IRÁ SUBSTITUIR SEUS DADOS ATUAIS.\n\nDeseja continuar?`)) {
                                StorageService.importLogs(importedLogs);
                                onImportSuccess();
                                alert("Dados restaurados com sucesso!");
                                onClose();
                            }
                        } else {
                            alert("Arquivo inválido. O formato deve ser JSON.");
                        }
                    } catch (err) {
                        alert("Erro ao ler o arquivo. Verifique se é um JSON válido.");
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold flex items-center"><Settings className="w-5 h-5 mr-2"/> Configurações</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100"><X className="w-5 h-5"/></button>
                        </div>
                        
                        {/* Seção IA */}
                        <div className="mb-6">
                            <h4 className="text-sm font-bold text-gray-500 uppercase mb-2">Inteligência Artificial</h4>
                            <input type="text" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="API Key do Gemini" className="w-full p-3 border rounded-xl mb-2 text-sm font-mono bg-gray-50" />
                            <button onClick={onSave} className="w-full bg-indigo-600 text-white font-bold py-2 rounded-xl text-sm hover:bg-indigo-700">Salvar Chave</button>
                        </div>

                        <hr className="border-gray-200 my-4" />

                        {/* Seção Backup */}
                        <div>
                            <h4 className="text-sm font-bold text-gray-500 uppercase mb-3">Backup & Dados</h4>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={handleExport} className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-indigo-300 transition group">
                                    <Download className="w-6 h-6 text-indigo-500 mb-2 group-hover:scale-110 transition"/>
                                    <span className="text-sm font-bold text-gray-700">Exportar</span>
                                    <span className="text-[10px] text-gray-400">Salvar JSON</span>
                                </button>

                                <button onClick={handleImportClick} className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-orange-300 transition group">
                                    <Upload className="w-6 h-6 text-orange-500 mb-2 group-hover:scale-110 transition"/>
                                    <span className="text-sm font-bold text-gray-700">Restaurar</span>
                                    <span className="text-[10px] text-gray-400">Carregar JSON</span>
                                </button>
                                {/* Input invisível para upload */}
                                <input 
                                    type="file" 
                                    accept=".json" 
                                    ref={fileInputRef} 
                                    style={{display: 'none'}} 
                                    onChange={handleFileChange}
                                />
                            </div>

                            <div className="mt-4 bg-yellow-50 p-3 rounded-lg flex items-start">
                                <AlertTriangle className="w-4 h-4 text-yellow-600 mt-0.5 mr-2 flex-shrink-0"/>
                                <p className="text-xs text-yellow-800">
                                    Use o <strong>Exportar</strong> antes de limpar o cache do navegador ou trocar de dispositivo. O <strong>Restaurar</strong> substitui os dados atuais.
                                </p>
                            </div>
                        </div>

                        <button onClick={onClose} className="w-full mt-6 py-3 text-gray-400 text-sm hover:text-gray-600">Fechar</button>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD VISUAL (MÉTRICAS) ---
        function MetricsSection({ logs, apiKey, onDelete, onUpdate, onRequireKey }) {
            const [view, setView] = useState('dashboard');
            const [analysis, setAnalysis] = useState('');
            const [loading, setLoading] = useState(false);
            const [editingLog, setEditingLog] = useState(null);

            // 1. Heatmap Data
            const heatmapData = useMemo(() => {
                const days = [];
                const today = new Date();
                for (let i = 27; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    const count = logs.filter(l => l.workoutDate === dateStr).length;
                    days.push({ date: dateStr, count, dayNum: d.getDate() });
                }
                return days;
            }, [logs]);

            // 2. Muscle Distribution
            const muscleStats = useMemo(() => {
                const stats = {};
                let total = 0;
                logs.forEach(l => {
                    stats[l.muscleGroup] = (stats[l.muscleGroup] || 0) + 1;
                    total++;
                });
                return Object.entries(stats)
                    .map(([name, count]) => ({ name, count, percent: total ? (count/total)*100 : 0 }))
                    .sort((a,b) => b.count - a.count);
            }, [logs]);

            // 3. PR Calculation
            const prs = useMemo(() => {
                const map = {};
                logs.forEach(l => {
                    const key = `${l.exercise} ${l.variation}`;
                    if(!map[key] || l.weight > map[key].maxW) {
                         map[key] = { maxW: l.weight, maxR: l.reps, date: l.dateString, group: l.muscleGroup }; 
                    }
                });
                return Object.entries(map);
            }, [logs]);

            // 4. Grouped History
            const groupedHistory = useMemo(() => {
                const groups = {};
                logs.forEach(l => {
                    if(!groups[l.dateString]) groups[l.dateString] = [];
                    groups[l.dateString].push(l);
                });
                return Object.entries(groups).sort((a,b) => {
                    const dateA = a[0].split('/').reverse().join('');
                    const dateB = b[0].split('/').reverse().join('');
                    return dateB.localeCompare(dateA);
                });
            }, [logs]);

            const analyze = async () => {
                if(!apiKey) return onRequireKey();
                setLoading(true);
                try {
                    const history = logs.slice(0, 20).map(l => `${l.dateString}: ${l.exercise} (${l.weight}kg)`).join('\n');
                    const prompt = `Analise este histórico (Markdown): \n${history}\n Dê 1 elogio e 1 dica.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    setAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch(e) { alert("Erro na IA. Verifique a chave ou conexão."); }
                setLoading(false);
            };

            return (
                <div className="animate-slide space-y-6">
                    <div className="flex bg-gray-200 p-1 rounded-xl">
                        <button onClick={() => setView('dashboard')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${view==='dashboard'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Visão Geral</button>
                        <button onClick={() => setView('history')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${view==='history'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Histórico Detalhado</button>
                    </div>

                    {view === 'dashboard' ? (
                        <>
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center"><Flame className="w-5 h-5 mr-2 text-orange-500" fill="currentColor"/> Frequência (30 dias)</h3>
                                <div className="grid grid-cols-7 gap-2">
                                    {heatmapData.map((d, i) => (
                                        <div key={i} className={`aspect-square rounded-md flex items-center justify-center text-[10px] font-bold transition-all hover:scale-110 ${d.count > 0 ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-gray-100 text-gray-300'}`}>
                                            {d.dayNum}
                                        </div>
                                    ))}
                                </div>
                                <p className="text-center text-xs text-gray-400 mt-3">Quanto mais cor, mais treino!</p>
                            </div>

                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center"><LayoutGrid className="w-5 h-5 mr-2 text-indigo-500"/> Foco Muscular</h3>
                                <div className="space-y-3">
                                    {muscleStats.map((s) => (
                                        <div key={s.name}>
                                            <div className="flex justify-between text-xs font-bold mb-1">
                                                <span className="text-gray-700">{s.name}</span>
                                                <span className="text-indigo-500">{Math.round(s.percent)}%</span>
                                            </div>
                                            <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                                <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{width: `${s.percent}%`}}></div>
                                            </div>
                                        </div>
                                    ))}
                                    {muscleStats.length === 0 && <p className="text-center text-xs text-gray-400">Nenhum dado.</p>}
                                </div>
                            </div>

                            <div className="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-3xl p-5 text-white shadow-lg relative overflow-hidden">
                                <Brain className="absolute right-0 top-0 w-24 h-24 text-white opacity-10 -mr-6 -mt-6"/>
                                <div className="relative z-10">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold flex items-center"><Sparkles className="w-4 h-4 mr-2 text-yellow-300"/> Análise IA</h3>
                                        <button onClick={analyze} disabled={loading} className="text-[10px] bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 font-bold">{loading ? "..." : "Gerar"}</button>
                                    </div>
                                    {analysis ? <div className="text-xs bg-black/20 p-3 rounded-xl whitespace-pre-wrap">{analysis}</div> : <p className="text-xs opacity-80">Descubra padrões ocultos no seu treino.</p>}
                                </div>
                            </div>

                            <div>
                                <h3 className="font-bold text-gray-800 mb-3 ml-1">Seus Recordes</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {prs.map(([name, data]) => (
                                        <div key={name} className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-between">
                                            <div>
                                                <span className="text-[10px] font-bold text-indigo-400 uppercase tracking-wide">{data.group}</span>
                                                <h4 className="font-bold text-gray-800 text-sm leading-tight mt-1 mb-2">{name}</h4>
                                            </div>
                                            <div className="flex items-end justify-between">
                                                <div className="text-2xl font-black text-gray-900">{data.maxW}<span className="text-xs font-normal text-gray-400 ml-0.5">kg</span></div>
                                                <div className="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500">{data.maxR}reps</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    ) : (
                        <div className="space-y-6 pb-10">
                            {groupedHistory.map(([date, items]) => (
                                <div key={date} className="relative pl-4 border-l-2 border-indigo-100">
                                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-indigo-500 border-4 border-white shadow-sm"></div>
                                    <h3 className="font-bold text-gray-800 mb-3 ml-2 text-lg">{date}</h3>
                                    <div className="space-y-2">
                                        {items.map(log => (
                                            <div key={log.id} className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group">
                                                <div>
                                                    <div className="font-bold text-gray-700 text-sm">{log.exercise} <span className="font-normal text-gray-400 text-xs">({log.variation})</span></div>
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <div className="text-right">
                                                        <span className="font-bold text-indigo-600">{log.weight}kg</span>
                                                        <span className="text-xs text-gray-400 ml-1">x {log.reps}</span>
                                                    </div>
                                                    <button onClick={()=>setEditingLog(log)} className="p-1.5 text-blue-300 hover:text-blue-500 transition"><Pencil className="w-4 h-4"/></button>
                                                    <button onClick={()=>onDelete(log.createdAt)} className="p-1.5 text-red-300 hover:text-red-500 transition"><Trash2 className="w-4 h-4"/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            {groupedHistory.length === 0 && <div className="text-center text-gray-400 py-10">Histórico vazio.</div>}
                        </div>
                    )}

                    {/* EDIT MODAL */}
                    {editingLog && (
                        <EditLogModal 
                            log={editingLog} 
                            onClose={() => setEditingLog(null)} 
                            onSave={(updatedLog) => {
                                onUpdate(updatedLog);
                                setEditingLog(null);
                            }} 
                        />
                    )}
                </div>
            );
        }

        // --- EDIT MODAL COMPONENT ---
        function EditLogModal({ log, onClose, onSave }) {
            const [weight, setWeight] = useState(log.weight);
            const [reps, setReps] = useState(log.reps);
            const [date, setDate] = useState(log.workoutDate);
            
            const [group, setGroup] = useState(log.muscleGroup);
            const [type, setType] = useState(log.exercise);
            const [variation, setVariation] = useState(log.variation);

            useEffect(() => {
                if (group && EXERCISE_CATALOG[group] && !EXERCISE_CATALOG[group][type]) {
                    setType('');
                    setVariation('');
                }
            }, [group]);

            useEffect(() => {
                 if (group && type && EXERCISE_CATALOG[group] && EXERCISE_CATALOG[group][type] && !EXERCISE_CATALOG[group][type].includes(variation)) {
                     setVariation('');
                 }
            }, [type]);

            const handleSave = () => {
                const [y, m, d] = date.split('-');
                onSave({
                    ...log, 
                    weight: parseFloat(weight),
                    reps: parseInt(reps),
                    workoutDate: date,
                    dateString: `${d}/${m}/${y}`,
                    muscleGroup: group,
                    exercise: type,
                    variation: variation
                });
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl relative">
                        <h3 className="text-xl font-bold mb-4 flex items-center text-indigo-600"><Pencil className="w-5 h-5 mr-2"/> Editar Registro</h3>
                        
                        <div className="space-y-4 max-h-[70vh] overflow-y-auto">
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase">Data</label>
                                <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-gray-50 p-2 rounded-lg font-bold outline-none"/>
                            </div>
                            
                            <Select label="Grupo" value={group} onChange={e=>setGroup(e.target.value)} options={Object.keys(EXERCISE_CATALOG)} />
                            {group && <Select label="Exercício" value={type} onChange={e=>setType(e.target.value)} options={Object.keys(EXERCISE_CATALOG[group]) || []} />}
                            {type && group && (
                                <div className="relative">
                                    <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Variação</label>
                                    <select value={variation} onChange={e=>setVariation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none">
                                        <option value="" disabled>Selecione...</option>
                                        {EXERCISE_CATALOG[group][type]?.map(v=><option key={v} value={v}>{v}</option>)}
                                    </select>
                                    <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-3">
                                <Input label="Carga (kg)" type="number" value={weight} onChange={e=>setWeight(e.target.value)} />
                                <Input label="Reps" type="number" value={reps} onChange={e=>setReps(e.target.value)} />
                            </div>
                        </div>

                        <div className="flex gap-3 mt-6">
                            <button onClick={onClose} className="flex-1 py-3 bg-gray-100 font-bold rounded-xl text-gray-600">Cancelar</button>
                            <button onClick={handleSave} className="flex-1 py-3 bg-indigo-600 font-bold rounded-xl text-white shadow-lg shadow-indigo-200">Salvar</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- LOGGER & PLANNER ---
        function LoggerSection({ onUpdateLogs, apiKey, onRequireKey }) {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [group, setGroup] = useState('');
            const [type, setType] = useState('');
            const [variation, setVariation] = useState('');
            const [weight, setWeight] = useState('');
            const [reps, setReps] = useState('');
            
            useEffect(() => { setType(''); setVariation(''); }, [group]);
            useEffect(() => { if(group && type) setVariation(EXERCISE_CATALOG[group][type][0] || ''); }, [type]);

            const handleSave = (e) => {
                e.preventDefault();
                const [y, m, d] = date.split('-');
                const log = {
                    id: Date.now(), muscleGroup: group, exercise: type, variation, weight: parseFloat(weight), reps: parseInt(reps),
                    workoutDate: date, dateString: `${d}/${m}/${y}`, createdAt: Date.now()
                };
                onUpdateLogs(StorageService.saveLog(log));
                alert("Salvo!"); setWeight(''); setReps('');
            };

            return (
                <div className="animate-slide bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center"><Plus className="w-5 h-5 mr-2 text-indigo-500"/> Novo Registro</h2>
                    <form onSubmit={handleSave} className="space-y-4">
                        <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Data</label>
                            <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-transparent font-bold text-gray-800 outline-none"/>
                        </div>
                        <Select label="Grupo" value={group} onChange={e=>setGroup(e.target.value)} options={Object.keys(EXERCISE_CATALOG)} />
                        {group && <Select label="Exercício" value={type} onChange={e=>setType(e.target.value)} options={Object.keys(EXERCISE_CATALOG[group])} />}
                        {type && (
                             <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Variação</label>
                                <select value={variation} onChange={e=>setVariation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none">
                                    {EXERCISE_CATALOG[group][type].map(v=><option key={v} value={v}>{v}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>
                        )}
                        <div className="grid grid-cols-2 gap-3">
                            <Input label="Carga (kg)" type="number" value={weight} onChange={e=>setWeight(e.target.value)} placeholder="0" />
                            <Input label="Reps" type="number" value={reps} onChange={e=>setReps(e.target.value)} placeholder="0" />
                        </div>
                        <button disabled={!variation || !weight} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 disabled:opacity-50 active:scale-95 transition">SALVAR</button>
                    </form>
                </div>
            );
        }

        function PlannerSection({ apiKey, onRequireKey }) {
            const [goal, setGoal] = useState('');
            const [plan, setPlan] = useState('');
            const [loading, setLoading] = useState(false);

            const handlePlan = async (e) => {
                e.preventDefault();
                if(!apiKey) return onRequireKey();
                setLoading(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Treino: "${goal}". Formate Markdown simples.` }] }] })
                    });
                    const data = await res.json();
                    setPlan(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch(e) { alert("Erro IA"); }
                setLoading(false);
            };

            return (
                <div className="animate-slide space-y-4">
                    <div className="bg-gradient-to-br from-teal-500 to-emerald-600 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden">
                        <Zap className="absolute right-0 top-0 w-32 h-32 opacity-10 -mr-6 -mt-6"/>
                        <h2 className="text-xl font-bold mb-2 flex items-center"><Map className="w-5 h-5 mr-2"/> Planejador IA</h2>
                        <textarea value={goal} onChange={e=>setGoal(e.target.value)} placeholder="Ex: Peito e Tríceps foco em força..." className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 outline-none h-24 text-sm"></textarea>
                        <button onClick={handlePlan} disabled={loading} className="mt-3 w-full bg-white text-teal-700 font-bold py-2 rounded-lg text-sm">{loading ? "Criando..." : "Gerar Treino"}</button>
                    </div>
                    {plan && <div className="bg-white p-5 rounded-3xl shadow-sm prose prose-sm max-w-none animate-fade">{plan.split('\n').map((l,i) => <p key={i} className={l.startsWith('#')?'font-bold text-teal-700':''}>{l.replace(/[*#]/g,'')}</p>)}</div>}
                </div>
            );
        }

        const Select = ({ label, value, onChange, options }) => (
            <div className="relative">
                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">{label}</label>
                <select value={value} onChange={onChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none">
                    <option value="" disabled>Selecione...</option>
                    {options.sort().map(o=><option key={o} value={o}>{o}</option>)}
                </select>
                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
            </div>
        );
        const Input = ({ label, ...props }) => (
            <div>
                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">{label}</label>
                <input {...props} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-center font-bold text-lg outline-none" />
            </div>
        );

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
