<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro PR's+ (Análise Completa)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        .animate-slide { animation: slideUp 0.4s ease-out; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="text-gray-900 selection:bg-indigo-100">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        // Ícones necessários
        import { BarChart2, Plus, Trash2, Pencil, Trophy, Sparkles, Brain, X, Settings, Download, Upload, Flame, LayoutGrid, ChevronDown, RefreshCw, TrendingUp, Hash, Clock, Route, Search, AlertTriangle } from 'lucide-react';

        // --- CONSTANTES ---
        const DEFAULT_API_KEY = "AIzaSyCZgPRLTn0OQZHB4rIj6bnWfrXTKRSWra0"; 

        // --- UTILITÁRIOS ---
        const getLocalTodayDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const parseDate = (dateStr) => {
            const [y, m, d] = dateStr.split('-');
            // Usa UTC para evitar problemas de fuso horário, mas garante que a data seja válida.
            return new Date(Date.UTC(y, m - 1, d));
        };
        const isCardio = (group) => group === 'Cardio';

        // --- CATÁLOGO COMPLETO ---
        const EXERCISE_CATALOG = {
            "Peitoral": {
                "Supino Reto": ["Barra Livre", "Halteres", "Smith", "Máquina Vertical", "Máquina Horizontal", "Articulado (Hammer)", "Chão (Floor Press)"],
                "Supino Inclinado": ["Barra Livre", "Halteres", "Smith", "Máquina", "Articulado (Hammer)"],
                "Supino Declinado": ["Barra Livre", "Halteres", "Smith", "Máquina", "Articulado"],
                "Crucifixo": ["Reto (Halteres)", "Inclinado (Halteres)", "Declinado (Halteres)", "Máquina (Peck Deck)", "Polia Média (Em pé)", "Banco Reto (Polia)"],
                "Crossover (Polia)": ["Polia Alta (Foco Inferior)", "Polia Baixa (Foco Superior)", "Polia Média"],
                "Flexão de Braço": ["Padrão (Chão)", "Pés Elevados (Inclinada)", "Mãos Elevadas (Declinada)", "Diamante (Fechada)", "Aberta", "Com Peso"],
                "Paralelas": ["Corpo Livre", "Máquina (Graviton)", "Com Peso Adicional"],
                "Pullover": ["Halter", "Barra", "Corda (Polia)"]
            },
            "Costas": {
                "Puxada Alta (Polia)": ["Frente (Pegada Aberta Pronada)", "Frente (Pegada Fechada Supinada)", "Triângulo (Neutra)", "Barra Romana (Neutra)", "Unilateral", "Articulada"],
                "Remada Curvada": ["Barra (Pronada)", "Barra (Supinada)", "Halteres (Bilateral)", "Smith"],
                "Remada Unilateral": ["Serrote (Halter)", "Kroc Rows", "Máquina Unilateral", "Polia Baixa"],
                "Remada Baixa (Sentado)": ["Triângulo", "Barra Romana", "Barra Reta (Pronada)", "Barra Reta (Supinada)", "Corda"],
                "Remada Máquina": ["Pegada Aberta (Pronada)", "Pegada Fechada (Neutra)", "Apoiada no Peito (Chest Supported)"],
                "Remada Cavalinho": ["Barra Livre", "Máquina"],
                "Levantamento Terra": ["Convencional", "Sumô", "Meio Terra (Rack Pull)", "Com Déficit"],
                "Barra Fixa": ["Pronada (Pull-up)", "Supinada (Chin-up)", "Neutra", "Graviton (Assistida)"],
                "Pullover (Dorsal)": ["Corda (Polia Alta)", "Barra Reta (Polia Alta)", "Máquina (Pullover)"],
                "Pulldown": ["Corda", "Barra Reta", "Triângulo"],
                "Extensão Lombar": ["Banco (Hiperextensão)", "Máquina", "Good Morning (Bom dia)"]
            },
            "Ombros": {
                "Desenvolvimento": ["Barra (Militar em Pé)", "Barra (Sentado)", "Halteres (Sentado)", "Halteres (Em Pé)", "Arnold Press", "Smith (Frente)", "Smith (Nuca)", "Máquina", "Articulado"],
                "Elevação Lateral": ["Halteres (Em Pé)", "Halteres (Sentado)", "Polia (Cabo)", "Máquina", "Unilateral (Inclinado)"],
                "Elevação Frontal": ["Halteres (Martelo)", "Halteres (Pronada)", "Barra", "Corda (Polia)", "Anilha"],
                "Posterior de Ombro": ["Crucifixo Inverso (Halter)", "Voador Inverso (Máquina)", "Face Pull (Polia)", "Crucifixo Inverso (Polia)"],
                "Remada Alta": ["Barra", "Polia", "Halteres"],
                "Encolhimento (Trapézio)": ["Barra", "Halteres", "Smith", "Máquina"]
            },
            "Pernas: Quadríceps": {
                "Agachamento": ["Livre (Barra Costas)", "Frontal (Barra)", "Sumô", "Halter (Goblet)", "Zercher", "Safety Bar"],
                "Agachamento Máquina": ["Smith", "Hack Machine", "V-Squat", "Pêndulo", "Sissy Squat"],
                "Leg Press": ["45 Graus", "Horizontal", "Vertical", "Unilateral"],
                "Cadeira Extensora": ["Bilateral", "Unilateral"],
                "Passada/Afundo": ["Avanço (Caminhando)", "Afundo Estático (Halter)", "Afundo (Smith)", "Agachamento Búlgaro", "Subida no Banco (Step-up)"]
            },
            "Pernas: Adutores": {
                 "Cadeira Adutora": ["Sentado"],
                 "Adução Polia": ["Em Pé"]
            },
            "Pernas: Posteriores": {
                "Mesa Flexora": ["Deitada (Bilateral)", "Deitada (Unilateral)"],
                "Cadeira Flexora": ["Sentada (Bilateral)", "Sentada (Unilateral)"],
                "Flexora em Pé": ["Máquina", "Caneleira"],
                "Stiff": ["Barra", "Halteres", "Smith"],
                "RDL (Romanian Deadlift)": ["Barra", "Halteres"],
                "Nordic Hamstring": ["Peso do Corpo", "Assistido"]
            },
            "Pernas: Glúteos": {
                "Elevação Pélvica": ["Barra Livre", "Máquina", "Smith", "Unilateral", "Halter"],
                "Cadeira Abdutora": ["Tronco Reto", "Tronco Inclinado"],
                "Glúteo Polia (Coice)": ["Perna Estendida", "Perna Flexionada"],
                "Glúteo Máquina": ["Coice", "Vertical"],
                "Caneleira": ["4 Apoios", "Em Pé"]
            },
            "Panturrilhas": {
                "Em Pé": ["Máquina", "Smith", "Livre (Degrau/Halter)", "Unilateral"],
                "Sentado": ["Banco (Gêmeos)", "Máquina", "No Leg Press"],
                "Burrinho": ["Máquina", "Com Parceiro"]
            },
            "Tríceps": {
                "Tríceps Polia (Cabo)": ["Corda", "Barra Reta", "Barra V", "Barra W", "Unilateral (Pegada Inversa)", "Unilateral (Pegada Neutra)"],
                "Tríceps Testa": ["Barra W", "Halteres", "Barra H", "Corda (Polia)"],
                "Tríceps Francês": ["Unilateral (Halter)", "Bilateral (Halter)", "Corda (Polia)", "Barra W (Sentado)"],
                "Supino Fechado": ["Barra", "Smith"],
                "Mergulho": ["Paralelas", "Banco", "Máquina (Graviton)"],
                "Coice": ["Halter", "Polia"]
            },
            "Bíceps": {
                "Rosca Direta": ["Barra Reta", "Barra W", "Polia Baixa (Barra)", "Polia Baixa (Unilateral)"],
                "Rosca na Polia": ["Unilateral (Polia Baixa)", "Bayeisan Curl (Polia)", "Corda (Martelo Polia)"],
                "Rosca Alternada": ["Halteres (Em pé)", "Halteres (Banco Inclinado 45º)", "Giro de Punho"],
                "Rosca Martelo": ["Halteres", "Corda (Polia)", "Barra H"],
                "Rosca Scott": ["Barra W", "Máquina", "Unilateral (Halter)"],
                "Rosca Concentrada": ["Halter", "Polia"],
                "Rosca Aranha": ["Barra W", "Halteres"],
                "Rosca 21": ["Barra W", "Barra Reta"]
            },
            "Antebraço": {
                "Flexão de Punho": ["Barra", "Halter", "Polia"],
                "Extensão de Punho": ["Barra", "Halter", "Polia"],
                "Rosca Inversa": ["Barra W", "Barra Reta", "Polia"]
            },
            "Abdômen / Core": {
                "Reto Abdominal": ["Supra (Chão)", "Supra (Máquina)", "Crunch (Polia/Corda)", "Banco Declinado"],
                "Infra": ["Elevação de Pernas (Chão)", "Elevação de Pernas (Barra)", "Tesoura"],
                "Oblíquos": ["Giro Russo (Russian Twist)", "Flexão Lateral de Tronco (Halter)", "Lenhador (Polia)"],
                "Isometria": ["Prancha Frontal", "Prancha Lateral", "Stomach Vacuum", "Roda Abdominal"]
            },
            "Cardio": {
                "Máquinas": ["Esteira (Caminhada)", "Esteira (Corrida)", "Bike Ergométrica", "Bike Spinning", "Elíptico", "Escada (Simulador)", "Remo Indoor"],
                "Livre": ["Pular Corda", "Corrida na Rua", "Caminhada", "Polichinelos", "Burpees"]
            }
        };

        // --- SERVIÇO DE STORAGE ---
        const StorageService = {
            KEY_LOGS: 'registro_prs_logs_v2',
            KEY_API: 'registro_prs_api_key',
            getLogs: () => {
                try {
                    const data = localStorage.getItem(StorageService.KEY_LOGS);
                    return data ? JSON.parse(data).sort((a, b) => b.createdAt - a.createdAt) : [];
                } catch (e) { console.error("Erro ao ler logs", e); return []; }
            },
            saveLog: (log) => {
                const logs = StorageService.getLogs();
                const sanitizedLog = {
                    ...log,
                    weight: log.weight || null,
                    reps: log.reps || null,
                    time: log.time || null,
                    distance: log.distance || null
                };
                const newLogs = [sanitizedLog, ...logs];
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return newLogs;
            },
            updateLog: (updatedLog) => {
                const logs = StorageService.getLogs();
                const index = logs.findIndex(l => l.id === updatedLog.id);
                if (index !== -1) {
                    logs[index] = updatedLog;
                    localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(logs));
                    return logs;
                }
                return logs;
            },
            deleteLog: (timestamp) => {
                const logs = StorageService.getLogs();
                const newLogs = logs.filter(l => l.createdAt !== timestamp);
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return newLogs;
            },
            importLogs: (newLogs) => {
                if (!Array.isArray(newLogs)) return false;
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return true;
            },
            getApiKey: () => {
                const stored = localStorage.getItem(StorageService.KEY_API);
                if (stored && stored.trim().length > 10) return stored;
                return DEFAULT_API_KEY;
            },
            setApiKey: (key) => localStorage.setItem(StorageService.KEY_API, key)
        };

        // --- MODAL DE MENSAGENS E CONFIRMAÇÃO (Estável) ---
        function MessageModal({ title, message, onConfirm, onClose, type = 'info' }) {
            let bgColor, icon;
            if (type === 'success') {
                bgColor = 'bg-green-600';
                icon = <Trophy className="w-6 h-6 text-white"/>;
            } else if (type === 'error') {
                bgColor = 'bg-red-600';
                icon = <AlertTriangle className="w-6 h-6 text-white"/>;
            } else if (type === 'confirm') {
                bgColor = 'bg-orange-600';
                icon = <Trash2 className="w-6 h-6 text-white"/>;
            } else { // info
                bgColor = 'bg-indigo-600';
                icon = <Sparkles className="w-6 h-6 text-white"/>;
            }

            const handleConfirm = onConfirm || onClose;
            const handleCancel = onClose;

            return (
                <div className="fixed inset-0 bg-black/70 z-[9999] flex items-center justify-center p-4 animate-fade backdrop-blur-sm">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl text-center">
                        <div className={`mx-auto ${bgColor} p-3 rounded-full w-fit mb-4`}>{icon}</div>
                        <h3 className="font-black text-xl text-gray-800 mb-2">{title}</h3>
                        <p className="text-sm text-gray-600 mb-6 whitespace-pre-wrap">{message}</p>
                        
                        {type === 'confirm' ? (
                            <div className="flex gap-3">
                                <button onClick={handleCancel} className="flex-1 border border-gray-300 text-gray-600 font-bold py-2 rounded-xl hover:bg-gray-50 transition">Cancelar</button>
                                <button onClick={handleConfirm} className="flex-1 bg-red-600 text-white font-bold py-2 rounded-xl hover:bg-red-700 transition">Confirmar</button>
                            </div>
                        ) : (
                            <button onClick={handleCancel} className="w-full bg-indigo-600 text-white font-bold py-2 rounded-xl hover:bg-indigo-700 transition">Entendi</button>
                        )}
                    </div>
                </div>
            );
        }

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [activeTab, setActiveTab] = useState('metrics'); 
            const [logs, setLogs] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [apiKey, setApiKey] = useState(''); 
            const [modal, setModal] = useState(null); 

            useEffect(() => {
                const keyToUse = StorageService.getApiKey();
                setLogs(StorageService.getLogs());
                setApiKey(keyToUse);
            }, []);
            
            // Função centralizada para exibir modais (incluindo confirm)
            const showMessage = (title, message, type = 'info', onConfirmAction = () => {}, onCloseAction = () => {}) => {
                 setModal({ 
                    title, 
                    message, 
                    type, 
                    onConfirm: () => { onConfirmAction(); setModal(null); }, 
                    onClose: () => { onCloseAction(); setModal(null); } 
                });
            }

            const handleSaveKey = () => {
                StorageService.setApiKey(apiKey);
                setShowSettings(false);
                showMessage("Chave Salva!", "O aplicativo agora usará sua chave API personalizada.", "success");
            };

            const handleDelete = (log) => {
                showMessage(
                    "Apagar Registro", 
                    `Tem certeza que deseja apagar o registro de ${log.exercise} (${log.dateString})? Esta ação é irreversível.`, 
                    'confirm', 
                    () => setLogs(StorageService.deleteLog(log.createdAt))
                );
            };

            const handleUpdate = (updatedLog) => {
                const newLogs = StorageService.updateLog(updatedLog);
                setLogs(newLogs.sort((a, b) => b.createdAt - a.createdAt));
                showMessage("Edição Salva", "O registro foi atualizado com sucesso.", "success");
            };

            const refreshLogs = () => setLogs(StorageService.getLogs());

            const resolveApiKey = () => {
                if (apiKey && apiKey.trim().length > 10) return apiKey;
                return DEFAULT_API_KEY;
            };

            return (
                <div className="min-h-screen pb-24 md:pb-0 font-sans text-gray-800 bg-gray-100 flex flex-col">
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-30 pt-[env(safe-area-inset-top)]">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <div className="bg-indigo-500 p-1.5 rounded-lg shadow-lg shadow-indigo-500/30">
                                    <Trophy className="h-5 w-5 text-yellow-300" fill="#fcd34d" strokeWidth={1.5}/>
                                </div>
                                <h1 className="text-lg font-black tracking-tight italic">REGISTRO <span className="text-indigo-400">PR's+</span></h1>
                            </div>
                            <button onClick={() => setShowSettings(true)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition active:scale-95">
                                <Settings className="w-5 h-5" />
                            </button>
                        </div>
                    </header>

                    {showSettings && (
                        <SettingsModal 
                            apiKey={apiKey} 
                            setApiKey={setApiKey} 
                            onSave={handleSaveKey} 
                            onClose={() => setShowSettings(false)}
                            logs={logs}
                            onImportSuccess={refreshLogs}
                            showMessage={showMessage}
                        />
                    )}

                    <main className="max-w-4xl mx-auto p-4 flex-grow w-full">
                        {activeTab === 'log' ? (
                            <LoggerSection onUpdateLogs={(newLogs) => setLogs(newLogs)} apiKey={resolveApiKey()} showMessage={showMessage} />
                        ) : (
                            <MetricsSection logs={logs} apiKey={resolveApiKey()} onDelete={handleDelete} onUpdate={handleUpdate} showMessage={showMessage} />
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 pb-[env(safe-area-inset-bottom)] md:hidden shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-20">
                        <NavBtn icon={BarChart2} label="Dash" active={activeTab === 'metrics'} onClick={() => setActiveTab('metrics')} />
                        <NavBtn icon={Plus} label="Registrar" active={activeTab === 'log'} onClick={() => setActiveTab('log')} />
                    </nav>

                    <div className="hidden md:flex justify-center mt-6 space-x-4 mb-10">
                        <DesktopBtn label="Dashboard / Análise" active={activeTab === 'metrics'} onClick={() => setActiveTab('metrics')} />
                        <DesktopBtn label="Registrar PR" active={activeTab === 'log'} onClick={() => setActiveTab('log')} />
                    </div>
                    
                    {modal && <MessageModal {...modal} />}
                </div>
            );
        }

        // --- COMPONENTES DE BOTÕES ---
        const NavBtn = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center p-2 rounded-xl transition w-full ${active ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:text-gray-600'}`}>
                <Icon className={`w-6 h-6 mb-1 ${active ? 'fill-current' : ''}`} strokeWidth={active ? 2.5 : 2} />
                <span className="text-[10px] font-bold">{label}</span>
            </button>
        );
        const DesktopBtn = ({ label, active, onClick }) => (
            <button onClick={onClick} className={`px-6 py-2 rounded-full font-bold text-sm transition transform hover:scale-105 ${active ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-gray-600 shadow border hover:bg-gray-50'}`}>{label}</button>
        );

        // --- MODAL DE CONFIGURAÇÕES (Estável) ---
        function SettingsModal({ apiKey, setApiKey, onSave, onClose, logs, onImportSuccess, showMessage }) {
            const fileInputRef = useRef(null);
            const isUsingDefault = !apiKey || apiKey === DEFAULT_API_KEY;

            const handleExport = () => {
                const dataStr = JSON.stringify(logs, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_pr_tracker_${getLocalTodayDate()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("Exportação Concluída", "Seu backup foi baixado como JSON.", "success");
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedLogs = JSON.parse(e.target.result);
                        if (Array.isArray(importedLogs)) {
                             onClose();
                             showMessage("Restaurar Dados", `Encontrados ${importedLogs.length} registros.\n\nISSO SUBSTITUIRÁ SEUS DADOS ATUAIS.\n\nDeseja continuar?`, 'confirm', 
                                 () => {
                                     StorageService.importLogs(importedLogs);
                                     onImportSuccess();
                                     showMessage("Sucesso!", "Dados restaurados com sucesso!", "success");
                                 }
                             );
                        } else {
                             showMessage("Erro", "Arquivo JSON inválido ou corrompido.", "error");
                        }
                    } catch (err) { 
                        showMessage("Erro", "Erro ao processar o arquivo.", "error");
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade backdrop-blur-sm">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold flex items-center text-slate-800"><Settings className="w-5 h-5 mr-2"/> Configurações</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100"><X className="w-5 h-5"/></button>
                        </div>
                        
                        <div className="mb-6 bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                            <h4 className="text-xs font-bold text-indigo-600 uppercase mb-2 tracking-wider flex items-center">
                                <Brain className="w-3 h-3 mr-1" /> Configuração da IA
                            </h4>
                            <p className="text-xs text-gray-600 mb-3">
                                Insira sua chave API para utilizar o Coach IA e o Gerador de Dicas. Suporta Gemini e outros modelos compatíveis.
                            </p>
                            <div className="text-xs text-gray-600 mb-3">
                                {isUsingDefault 
                                    ? <span className="text-red-600 font-bold">⚠️ Usando chave padrão (limitações)</span> 
                                    : <span className="text-blue-600 font-bold">✅ Usando sua chave personalizada</span>}
                            </div>
                            <label className="block text-xs text-gray-400 mb-1">Chave API (Ex: AIzaSy...)</label>
                            <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Chave padrão ativa..." className="w-full p-3 border border-gray-200 rounded-xl mb-2 text-sm font-mono bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                            <button onClick={onSave} className="w-full bg-indigo-600 text-white font-bold py-2 rounded-xl text-sm hover:bg-indigo-700 active:scale-95 transition">Salvar Chave</button>
                        </div>

                        <hr className="border-gray-100 my-4" />

                        <div>
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider">Gerenciar Dados</h4>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={handleExport} className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-indigo-300 transition group bg-white">
                                    <Download className="w-6 h-6 text-indigo-500 mb-2 group-hover:scale-110 transition"/>
                                    <span className="text-sm font-bold text-gray-700">Exportar</span>
                                    <span className="text-[10px] text-gray-400">Backup JSON</span>
                                </button>
                                <button onClick={() => fileInputRef.current.click()} className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-orange-300 transition group bg-white">
                                    <Upload className="w-6 h-6 text-orange-500 mb-2 group-hover:scale-110 transition"/>
                                    <span className="text-sm font-bold text-gray-700">Restaurar</span>
                                    <span className="text-[10px] text-gray-400">Ler JSON</span>
                                </button>
                                <input type="file" accept=".json" ref={fileInputRef} style={{display: 'none'}} onChange={handleFileChange} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD (METRICS) ---
        function MetricsSection({ logs, apiKey, onDelete, onUpdate, showMessage }) {
            const [view, setView] = useState('dashboard');
            const [dashboardView, setDashboardView] = useState('strength'); // strength | cardio
            const [analysis, setAnalysis] = useState('');
            const [loading, setLoading] = useState(false);
            const [editingLog, setEditingLog] = useState(null);
            
            // Filtros do Histórico
            const [searchTerm, setSearchTerm] = useState('');
            const [sortOrder, setSortOrder] = useState('dateDesc'); 

            const strengthLogs = useMemo(() => logs.filter(l => !isCardio(l.muscleGroup)), [logs]);
            const cardioLogs = useMemo(() => logs.filter(l => isCardio(l.muscleGroup)), [logs]);

            // --------------------------------------------------------
            // CÁLCULOS DE PROGRESSÃO (FORÇA)
            // --------------------------------------------------------
            const getProgressionStats = (filteredLogs) => {
                const maxWeightByExercise = {};
                filteredLogs.forEach(l => {
                    const key = `${l.exercise} (${l.variation})`;
                    const currentWeight = l.weight || 0;
                    const currentReps = l.reps || 0;

                    // PR: Maior Peso, em caso de empate, Maior Repetição
                    if (!maxWeightByExercise[key] || currentWeight > maxWeightByExercise[key].maxW || (currentWeight === maxWeightByExercise[key].maxW && currentReps > maxWeightByExercise[key].maxR)) {
                         maxWeightByExercise[key] = { maxW: currentWeight, maxR: currentReps, group: l.muscleGroup, date: parseDate(l.workoutDate), logId: l.id };
                    }
                });

                const periods = [{ label: '7 Dias', days: 7 }, { label: '15 Dias', days: 15 }, { label: '1 Mês', days: 30 }];

                const stats = Object.entries(maxWeightByExercise).map(([name, data]) => {
                    const currentPR = data.maxW;
                    
                    const progression = periods.map(period => {
                        const pastDate = new Date();
                        pastDate.setDate(pastDate.getDate() - period.days);
                        
                        let pastMaxW = 0;
                        filteredLogs.forEach(l => {
                            const logKey = `${l.exercise} (${l.variation})`;
                            if (logKey === name) {
                                const logDate = parseDate(l.workoutDate);
                                // FIX: Usando .getTime() para comparação robusta
                                if (logDate.getTime() < pastDate.getTime()) { 
                                    if ((l.weight || 0) > pastMaxW) {
                                        pastMaxW = (l.weight || 0);
                                    }
                                }
                            }
                        });

                        const diff = currentPR - pastMaxW;
                        const percent = pastMaxW > 0 ? (diff / pastMaxW) * 100 : (diff > 0 ? 100 : 0);

                        return { ...period, diff: parseFloat(diff.toFixed(1)), percent: parseFloat(percent.toFixed(1)) };
                    });

                    return { name, currentPR, group: data.group, progression, reps: data.maxR, date: data.date.toLocaleDateString('pt-BR') };
                }).sort((a, b) => b.currentPR - a.currentPR); 

                return stats;
            };
            
            const allStrengthPrs = useMemo(() => getProgressionStats(strengthLogs), [strengthLogs]);
            const progressionStats = useMemo(() => allStrengthPrs.slice(0, 5), [allStrengthPrs]); 

            // --------------------------------------------------------
            // CÁLCULOS DE PROGRESSÃO (CARDIO)
            // --------------------------------------------------------
            const getCardioProgressionStats = (filteredLogs) => {
                const maxMetricByExercise = {};

                filteredLogs.forEach(l => {
                    const key = `${l.exercise} (${l.variation})`;
                    const currentDistance = l.distance || 0;
                    const currentTime = l.time || 0;
                    
                    // Métrica principal: Maior Distância (km). Desempate: Menor Tempo.
                    if (currentDistance > 0 && currentTime > 0) {
                        if (!maxMetricByExercise[key] || 
                            currentDistance > maxMetricByExercise[key].maxD || 
                            (currentDistance === maxMetricByExercise[key].maxD && currentTime < maxMetricByExercise[key].time)) {
                            
                            maxMetricByExercise[key] = { maxD: currentDistance, time: currentTime, group: l.muscleGroup, date: l.workoutDate };
                        }
                    }
                });
                
                // Formata e ordena por Distância Máxima
                const combined = Object.entries(maxMetricByExercise).map(([name, data]) => ({
                    name, 
                    metric: data.maxD, 
                    unit: 'km', 
                    time: data.time, 
                    group: data.group, 
                    date: parseDate(data.date).toLocaleDateString('pt-BR')
                })).sort((a, b) => b.metric - a.metric);

                return combined;
            };
            
            const allCardioPrs = useMemo(() => getCardioProgressionStats(cardioLogs), [cardioLogs]);
            
            // Heatmap de constância (últimos 28 dias)
            const heatmapData = useMemo(() => {
                const days = [];
                const today = new Date();
                const offset = today.getTimezoneOffset() * 60000;
                
                for (let i = 27; i >= 0; i--) { 
                    const d = new Date(today.getTime() - (i * 86400000) - offset);
                    const dateStr = d.toISOString().split('T')[0];
                    const count = logs.filter(l => l.workoutDate === dateStr).length;
                    days.push({ date: dateStr, count, dayNum: d.getDate() });
                }
                return days;
            }, [logs]);

            // Estatísticas de Foco Muscular
            const muscleStats = useMemo(() => {
                const stats = {};
                let total = 0;
                logs.forEach(l => {
                    stats[l.muscleGroup] = (stats[l.muscleGroup] || 0) + 1;
                    total++;
                });
                return Object.entries(stats)
                    .map(([name, count]) => ({ name, count, percent: total ? (count/total)*100 : 0 }))
                    .sort((a,b) => b.count - a.count);
            }, [logs]);


            // --------------------------------------------------------
            // HISTÓRICO AGRUPADO E FILTRADO
            // --------------------------------------------------------
            const sortedAndFilteredLogs = useMemo(() => {
                let filtered = logs.filter(l => 
                    (l.exercise || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (l.variation || '').toLowerCase().includes(searchTerm.toLowerCase())
                );

                return filtered.sort((a, b) => {
                    if (sortOrder === 'dateDesc') return b.createdAt - a.createdAt;
                    if (sortOrder === 'dateAsc') return a.createdAt - b.createdAt;
                    
                    // Ordenação Métrica (Volume de Força ou Métrica de Cardio)
                    const valA = isCardio(a.muscleGroup) ? (a.distance || 0) - (a.time || 0) * 0.001 : (a.weight || 0) * (a.reps || 0);
                    const valB = isCardio(b.muscleGroup) ? (b.distance || 0) - (b.time || 0) * 0.001 : (b.weight || 0) * (b.reps || 0);
                    
                    if (sortOrder === 'metricDesc') return valB - valA;
                    if (sortOrder === 'metricAsc') return valA - valB;
                    
                    return 0;
                });
            }, [logs, searchTerm, sortOrder]);


            const groupedHistory = useMemo(() => {
                const groups = {};
                sortedAndFilteredLogs.forEach(l => {
                    if(!groups[l.dateString]) groups[l.dateString] = [];
                    groups[l.dateString].push(l);
                });
                return Object.entries(groups);
            }, [sortedAndFilteredLogs]);

            // Função de Análise da IA
            const analyze = async () => {
                if(!apiKey || apiKey === DEFAULT_API_KEY) { 
                    showMessage("Chave API Ausente", "Por favor, insira sua Chave API nas Configurações para usar o Coach IA.", "error"); 
                    return; 
                }

                if (strengthLogs.length === 0) {
                     setAnalysis("Registre alguns treinos de força primeiro para que o Coach IA possa analisar seu progresso!");
                     return;
                }

                setLoading(true);
                setAnalysis('');
                try {
                    const history = strengthLogs.slice(0, 30).map(l => `${l.dateString}: ${l.exercise} (${l.weight}kg x ${l.reps})`).join('\n');
                    const prompt = `Aja como um treinador pessoal focado em progressão de carga. Analise este histórico de treino recente (registros de peso/repetições) e me dê um feedback curto (máx 3 frases) e motivador sobre a progressão ou consistência. Destaque um ou dois PRs recentes (peso mais alto) se existirem. Histórico:\n${history}`;
                    
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (!res.ok) {
                         const errData = await res.json();
                         throw new Error(errData.error?.message || `Erro HTTP ${res.status}`);
                    }
                    
                    const data = await res.json();
                    setAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro na análise. Sem resposta.");
                } catch(e) { 
                    setAnalysis(`Erro na IA: ${e.message}. Verifique sua chave API.`); 
                }
                setLoading(false);
            };

            // Componente de Tabela de Progressão de PR (Força)
            const ProgressionTable = ({ stats }) => {
                if (stats.length === 0) return <p className="text-center text-xs text-gray-400 italic py-4">Registre dados de treino de força para ver a progressão.</p>;
                
                return (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Exercício (PR)</th>
                                    {['7 Dias', '15 Dias', '1 Mês'].map(label => (
                                        <th key={label} className="px-2 py-2 text-center text-[10px] font-bold text-gray-500 uppercase tracking-wider">vs {label}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-100">
                                {stats.map((item, index) => (
                                    <tr key={index} className="hover:bg-indigo-50/50 transition">
                                        <td className="px-3 py-3 whitespace-nowrap">
                                            <div className="font-bold text-gray-800 text-xs line-clamp-2">{item.name.split('(')[0].trim()}</div>
                                            <div className="text-xs font-black text-indigo-600">{item.currentPR}<span className="text-[10px] text-gray-400 ml-0.5">kg</span></div>
                                        </td>
                                        {item.progression.map((p, pIndex) => (
                                            <td key={pIndex} className="px-2 py-3 whitespace-nowrap text-center">
                                                <div className={`font-black text-xs ${p.diff > 0 ? 'text-green-600' : p.diff < 0 ? 'text-red-500' : 'text-gray-500'}`}>
                                                    {p.diff > 0 ? `+${p.diff}` : p.diff}kg
                                                </div>
                                                <div className={`text-[10px] font-bold ${p.percent > 0 ? 'text-green-500' : p.percent < 0 ? 'text-red-400' : 'text-gray-400'}`}>
                                                    ({p.percent}%)
                                                </div>
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };

            // Componente de Ranking Global de PRs (Força)
            const StrengthRankingTable = ({ prs }) => {
                if (prs.length === 0) return <p className="text-center text-xs text-gray-400 italic py-4">Nenhum recorde de força registrado ainda.</p>;

                return (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-3 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-10"><Hash className="w-3 h-3 mx-auto"/></th>
                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Exercício (Grupo)</th>
                                    <th className="px-3 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">PR Máximo</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-100">
                                {prs.map((item, index) => (
                                    <tr key={item.name} className="hover:bg-yellow-50/50 transition">
                                        <td className="px-3 py-3 whitespace-nowrap text-center font-black text-lg text-yellow-600">{index + 1}</td>
                                        <td className="px-3 py-3 whitespace-nowrap">
                                            <div className="font-bold text-gray-800 text-sm line-clamp-1">{item.name}</div>
                                            <div className="text-[10px] text-indigo-500 font-semibold uppercase">{item.group}</div>
                                        </td>
                                        <td className="px-3 py-3 whitespace-nowrap text-center">
                                            <div className="font-black text-indigo-700 text-xl leading-none">{item.currentPR}<span className="text-xs font-normal ml-0.5">kg</span></div>
                                            <div className="text-[10px] text-gray-400 font-bold">{item.reps} reps</div>
                                            <div className="text-[9px] text-gray-400 mt-1">{item.date}</div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };
            
            // Componente de Ranking de Cardio
            const CardioRankingTable = ({ prs }) => {
                if (prs.length === 0) return <p className="text-center text-xs text-gray-400 italic py-4">Nenhum recorde de Cardio (Distância) registrado ainda.</p>;

                return (
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200 text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-3 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider w-10"><Hash className="w-3 h-3 mx-auto"/></th>
                                    <th className="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Atividade</th>
                                    <th className="px-3 py-2 text-center text-xs font-bold text-gray-500 uppercase tracking-wider">Melhor Métrica</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-100">
                                {prs.map((item, index) => (
                                    <tr key={item.name} className="hover:bg-emerald-50/50 transition">
                                        <td className="px-3 py-3 whitespace-nowrap text-center font-black text-lg text-emerald-600">{index + 1}</td>
                                        <td className="px-3 py-3 whitespace-nowrap">
                                            <div className="font-bold text-gray-800 text-sm line-clamp-1">{item.name.split('(')[0].trim()}</div>
                                            <div className="text-[10px] text-gray-500 font-semibold uppercase">{item.group}</div>
                                        </td>
                                        <td className="px-3 py-3 whitespace-nowrap text-center">
                                            <div className="font-black text-emerald-700 text-xl leading-none">{item.metric}<span className="text-xs font-normal ml-0.5">km</span></div>
                                            <div className="text-[10px] text-gray-400 font-bold">{item.time} min</div>
                                            <div className="text-[9px] text-gray-400 mt-1">{item.date}</div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };


            return (
                <div className="animate-slide space-y-6">
                    <div className="flex bg-gray-200 p-1 rounded-xl">
                        <button onClick={() => setView('dashboard')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${view==='dashboard'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Visão Geral</button>
                        <button onClick={() => setView('history')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${view==='history'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Histórico</button>
                    </div>

                    {view === 'dashboard' ? (
                        <>
                            {/* Card Coach IA */}
                            <div className="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-3xl p-5 text-white shadow-lg relative overflow-hidden">
                                <Brain className="absolute right-0 top-0 w-24 h-24 text-white opacity-10 -mr-6 -mt-6"/>
                                <div className="relative z-10">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold flex items-center"><Sparkles className="w-4 h-4 mr-2 text-yellow-300"/> Coach IA (Análise de Treino)</h3>
                                        <button onClick={analyze} disabled={loading} className="text-[10px] bg-white/20 px-3 py-1.5 rounded-full hover:bg-white/30 font-bold transition disabled:opacity-50">
                                            {loading ? "Pensando..." : "Analisar Progresso"}
                                        </button>
                                    </div>
                                    <div className="bg-black/20 p-3 rounded-xl min-h-[60px]">
                                        {analysis ? <div className="text-xs whitespace-pre-wrap leading-relaxed">{analysis}</div> : <p className="text-xs opacity-70 italic">Toque em analisar para receber feedback personalizado sobre seus registros de carga.</p>}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Card de Progressão de Carga (FORÇA) */}
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center text-sm uppercase tracking-wider"><TrendingUp className="w-4 h-4 mr-2 text-green-500" fill="currentColor"/> Progressão de Carga (Força - Top 5)</h3>
                                <ProgressionTable stats={progressionStats} />
                            </div>

                            {/* Ranking de Treino - Abas */}
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                                    <button onClick={() => setDashboardView('strength')} className={`flex-1 py-1.5 rounded-md text-sm font-bold transition ${dashboardView==='strength'?'bg-indigo-50 shadow text-indigo-600':'text-gray-500'}`}>Força (Peso)</button>
                                    <button onClick={() => setDashboardView('cardio')} className={`flex-1 py-1.5 rounded-md text-sm font-bold transition ${dashboardView==='cardio'?'bg-emerald-50 shadow text-emerald-600':'text-gray-500'}`}>Cardio (Dist/Tempo)</button>
                                </div>

                                {dashboardView === 'strength' ? (
                                    <StrengthRankingTable prs={allStrengthPrs} />
                                ) : (
                                    <CardioRankingTable prs={allCardioPrs} />
                                )}
                            </div>

                            {/* Card de Constância (Heatmap) */}
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center text-sm uppercase tracking-wider"><Flame className="w-4 h-4 mr-2 text-orange-500" fill="currentColor"/> Constância (Últimos 28 dias)</h3>
                                <div className="grid grid-cols-7 gap-2">
                                    {heatmapData.map((d, i) => (
                                        <div 
                                            key={i} 
                                            title={d.date}
                                            className={`aspect-square rounded-md flex items-center justify-center text-[10px] font-bold transition-all hover:scale-110 ${d.count > 0 ? 'text-white shadow-md shadow-indigo-200' : 'bg-gray-100 text-gray-300'}`}
                                            style={{
                                                backgroundColor: d.count > 0 ? `rgba(99, 102, 241, ${Math.min(1, d.count * 0.4)})` : undefined, 
                                                borderColor: d.count > 0 ? '#6366F1' : '#E5E7EB'
                                            }}
                                        >
                                            {d.dayNum}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Card Foco Muscular */}
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center text-sm uppercase tracking-wider"><LayoutGrid className="w-4 h-4 mr-2 text-indigo-500"/> Foco Muscular (Distribuição)</h3>
                                <div className="space-y-3">
                                    {muscleStats.slice(0, 5).map((s) => (
                                        <div key={s.name}>
                                            <div className="flex justify-between text-xs font-bold mb-1">
                                                <span className="text-gray-700">{s.name}</span>
                                                <span className="text-indigo-500">{Math.round(s.percent)}%</span>
                                            </div>
                                            <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                                <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{width: `${s.percent}%`}}></div>
                                            </div>
                                        </div>
                                    ))}
                                    {muscleStats.length === 0 && <p className="text-center text-xs text-gray-400">Nenhum dado registrado.</p>}
                                </div>
                            </div>
                        </>
                    ) : (
                        // Histórico Detalhado (Com Filtros e Ordenação)
                        <div className="space-y-6 pb-10">
                            <div className="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 space-y-3">
                                <div className="relative">
                                    <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/>
                                    <input 
                                        type="text" 
                                        placeholder="Filtrar por exercício ou variação..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full p-2 pl-9 border border-gray-200 rounded-xl text-sm outline-none focus:ring-1 focus:ring-indigo-300"
                                    />
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-gray-500 font-medium">Ordenar por:</span>
                                    <select 
                                        value={sortOrder}
                                        onChange={(e) => setSortOrder(e.target.value)}
                                        className="p-1.5 border border-gray-200 rounded-lg text-sm bg-white font-bold outline-none"
                                    >
                                        <option value="dateDesc">Mais Recente</option>
                                        <option value="dateAsc">Mais Antigo</option>
                                        <option value="metricDesc">Maior Métrica (Carga/Dist)</option>
                                        <option value="metricAsc">Menor Métrica</option>
                                    </select>
                                </div>
                            </div>

                            {groupedHistory.map(([date, items]) => (
                                <div key={date} className="relative pl-6 border-l-2 border-indigo-100">
                                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-indigo-500 border-4 border-white shadow-sm"></div>
                                    <h3 className="font-bold text-gray-800 mb-4 text-lg">{date}</h3>
                                    <div className="space-y-3">
                                        {items.map(log => (
                                            <div key={log.id} className="bg-white p-3.5 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group active:scale-[0.99] transition">
                                                <div className="flex-1 pr-2">
                                                    <div className="font-bold text-gray-700 text-sm">{log.exercise}</div>
                                                    <div className="text-xs text-gray-400 line-clamp-1">{log.variation}</div>
                                                </div>
                                                <div className="flex items-center space-x-3">
                                                    <div className="text-right">
                                                        {isCardio(log.muscleGroup) ? (
                                                            <>
                                                                <div className="font-bold text-emerald-600 text-base">{log.time || 0}<span className="text-xs font-normal ml-0.5">min</span></div>
                                                                <div className="text-[10px] text-gray-400">{log.distance || 0} km</div>
                                                            </>
                                                        ) : (
                                                            <>
                                                                <div className="font-bold text-indigo-600 text-base">{log.weight || 0}kg</div>
                                                                <div className="text-[10px] text-gray-400">{log.reps || 0} reps</div>
                                                            </>
                                                        )}
                                                    </div>
                                                    <div className="flex flex-col space-y-1">
                                                        <button onClick={()=>setEditingLog(log)} className="p-1.5 bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-100"><Pencil className="w-3 h-3"/></button>
                                                        <button onClick={()=>onDelete(log)} className="p-1.5 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><Trash2 className="w-3 h-3"/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            {groupedHistory.length === 0 && <div className="text-center text-gray-400 py-10 italic">Nenhum treino encontrado com o filtro atual.</div>}
                        </div>
                    )}
                    {editingLog && (
                        <EditLogModal log={editingLog} onClose={() => setEditingLog(null)} onSave={(updatedLog) => { onUpdate(updatedLog); setEditingLog(null); }} />
                    )}
                </div>
            );
        }

        // --- EDIT MODAL (Estável) ---
        function EditLogModal({ log, onClose, onSave }) {
            const [weight, setWeight] = useState(log.weight || '');
            const [reps, setReps] = useState(log.reps || '');
            const [time, setTime] = useState(log.time || '');
            const [distance, setDistance] = useState(log.distance || '');

            const [date, setDate] = useState(log.workoutDate);
            const [group, setGroup] = useState(log.muscleGroup);
            const [type, setType] = useState(log.exercise);
            const [variation, setVariation] = useState(log.variation);

            const isNewCardio = isCardio(group);

            useEffect(() => {
                if (group && EXERCISE_CATALOG[group] && !EXERCISE_CATALOG[group][type]) { 
                    setType(''); 
                    setVariation('');
                }
            }, [group]);

            const handleSave = () => {
                const [y, m, d] = date.split('-');
                let updatedMetrics = {};

                if (isNewCardio) {
                    updatedMetrics = { 
                        weight: null, 
                        reps: null, 
                        time: parseFloat(time) || 0, 
                        distance: parseFloat(distance) || 0 
                    };
                } else {
                    updatedMetrics = { 
                        weight: parseFloat(weight) || 0, 
                        reps: parseInt(reps) || 0, 
                        time: null, 
                        distance: null 
                    };
                }
                
                onSave({
                    ...log, 
                    ...updatedMetrics,
                    workoutDate: date, 
                    dateString: `${d}/${m}/${y}`, 
                    muscleGroup: group, 
                    exercise: type, 
                    variation: variation
                });
            };

            const exerciseOptions = (group && EXERCISE_CATALOG[group]) ? Object.keys(EXERCISE_CATALOG[group]) : [];
            const variationOptions = (group && type && EXERCISE_CATALOG[group] && EXERCISE_CATALOG[group][type]) ? EXERCISE_CATALOG[group][type] : [];

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade backdrop-blur-sm">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl relative">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold flex items-center text-indigo-600"><Pencil className="w-5 h-5 mr-2"/> Editar Registro</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100"><X className="w-5 h-5 text-gray-400"/></button>
                        </div>
                        
                        <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-1">
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase">Data</label>
                                <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-gray-50 p-3 rounded-xl font-bold outline-none text-gray-700"/>
                            </div>
                            
                            <Select label="Grupo" value={group} onChange={e=>{setGroup(e.target.value); setType(''); setVariation('');}} options={Object.keys(EXERCISE_CATALOG)} />
                            
                            <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Exercício</label>
                                <select value={type} onChange={e=>{setType(e.target.value); setVariation('');}} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                                    <option value="" disabled>Selecione...</option>
                                    {!exerciseOptions.includes(type) && type && <option value={type}>{type} (Arquivo)</option>}
                                    {exerciseOptions.sort().map(o=><option key={o} value={o}>{o}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>

                            <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Variação</label>
                                <select value={variation} onChange={e=>setVariation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-sm text-gray-700">
                                    <option value="" disabled>Selecione...</option>
                                    {!variationOptions.includes(variation) && variation && <option value={variation}>{variation} (Arquivo)</option>}
                                    {variationOptions.map(v=><option key={v} value={v}>{v}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                {isNewCardio ? (
                                    <>
                                        <Input label="Tempo (min)" type="number" value={time} onChange={e=>setTime(e.target.value)} icon={Clock} />
                                        <Input label="Distância (km)" type="number" value={distance} onChange={e=>setDistance(e.target.value)} step="0.1" icon={Route} />
                                    </>
                                ) : (
                                    <>
                                        <Input label="Carga (kg)" type="number" value={weight} onChange={e=>setWeight(e.target.value)} />
                                        <Input label="Reps" type="number" value={reps} onChange={e=>setReps(e.target.value)} />
                                    </>
                                )}
                            </div>
                        </div>

                        <button onClick={handleSave} className="w-full mt-6 py-3 bg-indigo-600 font-bold rounded-xl text-white shadow-lg shadow-indigo-200 active:scale-95 transition">Salvar Alterações</button>
                    </div>
                </div>
            );
        }

        // --- LOGGER (REGISTRO) (Estável) ---
        function LoggerSection({ onUpdateLogs, apiKey, showMessage }) {
            const [date, setDate] = useState(getLocalTodayDate());
            const [group, setGroup] = useState('');
            const [type, setType] = useState('');
            const [variation, setVariation] = useState('');
            
            const [weight, setWeight] = useState('');
            const [reps, setReps] = useState('');
            const [time, setTime] = useState('');
            const [distance, setDistance] = useState('');

            const [showTips, setShowTips] = useState(false);
            const [tipLoading, setTipLoading] = useState(false);
            const [tipContent, setTipContent] = useState('');
            const [altContent, setAltContent] = useState('');

            const isCurrentCardio = isCardio(group);

            useEffect(() => { setType(''); setVariation(''); setTipContent(''); setAltContent(''); setShowTips(false); }, [group]);
            useEffect(() => { 
                if(group && type && EXERCISE_CATALOG[group] && EXERCISE_CATALOG[group][type]) {
                    setVariation(EXERCISE_CATALOG[group][type][0] || '');
                }
                setTipContent(''); setAltContent(''); setShowTips(false);
            }, [type]);

            const fetchTips = async () => { 
                if(!apiKey || apiKey === DEFAULT_API_KEY) { showMessage("Chave API Ausente", "Por favor, insira sua Chave API nas Configurações para usar as Dicas de Execução.", "error"); return; }
                if(isCurrentCardio) { setTipContent("Dicas de execução não se aplicam a Cardio da mesma forma. Registre apenas a performance!"); return; }

                setShowTips(true);
                setAltContent(''); 
                if(tipContent) return; 

                setTipLoading(true);
                try {
                    const prompt = `Explique de forma resumida e direta (em bullet points) a forma correta de executar o exercício: ${type} (${variation}). Dê 2 dicas de segurança cruciais para este movimento.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!res.ok) throw new Error("Erro na API de Geração");
                    const data = await res.json();
                    setTipContent(data.candidates?.[0]?.content?.parts?.[0]?.text || "Sem resposta.");
                } catch(e) { setTipContent(`Erro: ${e.message}. Verifique sua chave.`); }
                setTipLoading(false);
            };

            const fetchAlternative = async () => { 
                if(!apiKey || apiKey === DEFAULT_API_KEY) { showMessage("Chave API Ausente", "Por favor, insira sua Chave API nas Configurações para usar as Sugestões de Alternativas.", "error"); return; }
                if(isCurrentCardio) { setAltContent("Alternativas não são fornecidas para Cardio. Escolha na lista ou registre a performance!"); return; }

                setShowTips(true);
                setTipContent('');
                if(altContent) return;

                setTipLoading(true);
                try {
                    const prompt = `Sugira uma alternativa biomecanicamente similar para o exercício ${type} (${variation}) que possa ser feita em casa ou com equipamentos simples. Seja direto e explique o foco muscular.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!res.ok) throw new Error("Erro na API de Geração");
                    const data = await res.json();
                    setAltContent(data.candidates?.[0]?.content?.parts?.[0]?.text || "Sem resposta.");
                } catch(e) { setAltContent(`Erro: ${e.message}. Verifique sua chave.`); }
                setTipLoading(false);
            };


            const handleSave = (e) => {
                e.preventDefault();
                let logData = {};
                let isValid = false;

                if (isCurrentCardio) {
                    isValid = (variation && (parseFloat(time) > 0 || parseFloat(distance) > 0));
                    logData = { weight: null, reps: null, time: parseFloat(time) || 0, distance: parseFloat(distance) || 0 };
                } else {
                    isValid = (variation && parseFloat(weight) > 0 && parseInt(reps) > 0);
                    logData = { weight: parseFloat(weight) || 0, reps: parseInt(reps) || 0, time: null, distance: null };
                }

                if (!isValid) {
                    showMessage("Campos Inválidos", "Preencha todos os campos obrigatórios (Carga/Reps ou Tempo/Distância) e selecione o exercício.", "error");
                    return;
                }

                const [y, m, d] = date.split('-');
                const log = {
                    id: Date.now(), muscleGroup: group, exercise: type, variation, 
                    workoutDate: date, dateString: `${d}/${m}/${y}`, createdAt: Date.now(),
                    ...logData
                };
                onUpdateLogs(StorageService.saveLog(log));
                
                // Reseta campos
                setWeight(''); setReps(''); setTime(''); setDistance('');
                showMessage("Registro Salvo!", `${isCurrentCardio ? 'Cardio' : 'Série'} registrada com sucesso.`, "success");
            };

            const exerciseOptions = (group && EXERCISE_CATALOG[group]) ? Object.keys(EXERCISE_CATALOG[group]) : [];
            const variationOptions = (group && type && EXERCISE_CATALOG[group]?.[type]) ? EXERCISE_CATALOG[group][type] : [];

            return (
                <div className="animate-slide bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center"><Plus className="w-5 h-5 mr-2 text-indigo-500"/> Novo Registro</h2>
                    <form onSubmit={handleSave} className="space-y-4">
                        <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Data do Treino</label>
                            <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-transparent font-bold text-gray-800 outline-none mt-1"/>
                        </div>
                        
                        <Select label="Grupo Muscular" value={group} onChange={e=>setGroup(e.target.value)} options={Object.keys(EXERCISE_CATALOG)} />
                        
                        {group && exerciseOptions.length > 0 && (
                            <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Exercício</label>
                                <select value={type} onChange={e=>setType(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                                    <option value="" disabled>Selecione...</option>
                                    {exerciseOptions.sort().map(o=><option key={o} value={o}>{o}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>
                        )}
                        
                        {type && variationOptions.length > 0 && (
                             <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Variação</label>
                                <select value={variation} onChange={e=>setVariation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                                    {variationOptions.map(v=><option key={v} value={v}>{v}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>
                        )}

                        {/* BOTÕES DE IA (Só se aplicam a treino de força) */}
                        {type && variation && !isCurrentCardio && (
                            <div className="mt-2">
                                <div className="flex gap-3">
                                    <button type="button" onClick={fetchTips} className="text-xs flex items-center text-indigo-500 font-bold hover:text-indigo-700 transition bg-indigo-50 px-2 py-1 rounded-lg">
                                        <Sparkles className="w-3 h-3 mr-1" /> Como fazer?
                                    </button>
                                    <button type="button" onClick={fetchAlternative} className="text-xs flex items-center text-emerald-600 font-bold hover:text-emerald-800 transition bg-emerald-50 px-2 py-1 rounded-lg">
                                        <RefreshCw className="w-3 h-3 mr-1" /> Substituir (IA)
                                    </button>
                                </div>
                                {showTips && (
                                    <div className="mt-2 p-3 bg-white rounded-xl text-xs text-gray-700 border border-gray-200 leading-relaxed animate-fade shadow-sm">
                                        {tipLoading ? 
                                            <div className="flex items-center space-x-2 text-indigo-500">
                                                <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                                <span>Consultando coach...</span>
                                            </div>
                                            : 
                                            <div className="whitespace-pre-wrap">
                                                {tipContent && <><span className="font-bold text-indigo-600 block mb-1">Dicas de Execução:</span>{tipContent}</>}
                                                {altContent && <><span className="font-bold text-emerald-600 block mb-1">Alternativa Sugerida:</span>{altContent}</>}
                                            </div>
                                        }
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Renderização Condicional de Métricas */}
                        <div className="grid grid-cols-2 gap-3 pt-2">
                            {isCurrentCardio ? (
                                <>
                                    <Input label="Tempo (min)" type="number" value={time} onChange={e=>setTime(e.target.value)} placeholder="0" min="0" step="1" icon={Clock} />
                                    <Input label="Distância (km)" type="number" value={distance} onChange={e=>setDistance(e.target.value)} placeholder="0" min="0" step="0.1" icon={Route} />
                                </>
                            ) : (
                                <>
                                    <Input label="Carga (kg)" type="number" value={weight} onChange={e=>setWeight(e.target.value)} placeholder="0" step="0.5" min="0" />
                                    <Input label="Reps" type="number" value={reps} onChange={e=>setReps(e.target.value)} placeholder="0" min="1" />
                                </>
                            )}
                        </div>
                        <button disabled={!variation || (isCurrentCardio ? (!time && !distance) : (!weight || !reps))} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 disabled:opacity-50 disabled:shadow-none active:scale-95 transition mt-4">
                            CONFIRMAR SÉRIE
                        </button>
                    </form>
                </div>
            );
        }
        
        // --- COMPONENTES AUXILIARES ---
        const Select = ({ label, value, onChange, options }) => (
            <div className="relative">
                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">{label}</label>
                <select value={value} onChange={onChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                    <option value="" disabled>Selecione...</option>
                    {options.sort().map(o=><option key={o} value={o}>{o}</option>)}
                </select>
                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
            </div>
        );
        const Input = ({ label, icon: Icon, ...props }) => (
            <div>
                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">{label}</label>
                <div className="relative">
                    {Icon && <Icon className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"/>}
                    <input {...props} className={`w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-center font-bold text-lg outline-none focus:ring-2 focus:ring-indigo-200 transition text-gray-800 ${Icon ? 'pl-8 pr-3' : 'px-3'}`} />
                </div>
            </div>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

