<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro PR's+ (Diagnóstico)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f3f4f6;
            overscroll-behavior-y: none;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        .animate-slide { animation: slideUp 0.4s ease-out; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.300.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="text-gray-900 selection:bg-indigo-100">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Activity, BarChart2, Plus, Calendar, Trash2, ChevronDown, Trophy, Sparkles, Brain, X, Map, Zap, Settings, Download, Upload, Flame, LayoutGrid, Pencil, Utensils, ChefHat, HelpCircle, Info } from 'lucide-react';

        // --- CONSTANTES ---
        // Chave fornecida
        const DEFAULT_API_KEY = "AIzaSyCZgPRLTn0OQZHB4rIj6bnWfrXTKRSWra0"; 

        // --- UTILITÁRIO DE DATA LOCAL ---
        const getLocalTodayDate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- CATÁLOGO COMPLETO ---
        const EXERCISE_CATALOG = {
            "Peitoral": {
                "Supino Reto": ["Barra Livre", "Halteres", "Smith", "Máquina Vertical", "Máquina Horizontal", "Articulado (Hammer)", "Chão (Floor Press)"],
                "Supino Inclinado": ["Barra Livre", "Halteres", "Smith", "Máquina", "Articulado (Hammer)"],
                "Supino Declinado": ["Barra Livre", "Halteres", "Smith", "Máquina", "Articulado"],
                "Crucifixo": ["Reto (Halteres)", "Inclinado (Halteres)", "Declinado (Halteres)", "Máquina (Peck Deck)", "Polia Média (Em pé)", "Banco Reto (Polia)"],
                "Crossover (Polia)": ["Polia Alta (Foco Inferior)", "Polia Baixa (Foco Superior)", "Polia Média"],
                "Flexão de Braço": ["Padrão (Chão)", "Pés Elevados (Inclinada)", "Mãos Elevadas (Declinada)", "Diamante (Fechada)", "Aberta", "Com Peso"],
                "Paralelas": ["Corpo Livre", "Máquina (Graviton)", "Com Peso Adicional"],
                "Pullover": ["Halter", "Barra", "Corda (Polia)"]
            },
            "Costas": {
                "Puxada Alta (Polia)": ["Frente (Pegada Aberta Pronada)", "Frente (Pegada Fechada Supinada)", "Triângulo (Neutra)", "Barra Romana (Neutra)", "Unilateral", "Articulada"],
                "Remada Curvada": ["Barra (Pronada)", "Barra (Supinada)", "Halteres (Bilateral)", "Smith"],
                "Remada Unilateral": ["Serrote (Halter)", "Kroc Rows", "Máquina Unilateral", "Polia Baixa"],
                "Remada Baixa (Sentado)": ["Triângulo", "Barra Romana", "Barra Reta (Pronada)", "Barra Reta (Supinada)", "Corda"],
                "Remada Máquina": ["Pegada Aberta (Pronada)", "Pegada Fechada (Neutra)", "Apoiada no Peito (Chest Supported)"],
                "Remada Cavalinho": ["Barra Livre", "Máquina"],
                "Levantamento Terra": ["Convencional", "Sumô", "Meio Terra (Rack Pull)", "Com Déficit"],
                "Barra Fixa": ["Pronada (Pull-up)", "Supinada (Chin-up)", "Neutra", "Graviton (Assistida)"],
                "Pullover (Dorsal)": ["Corda (Polia Alta)", "Barra Reta (Polia Alta)", "Máquina (Pullover)"],
                "Pulldown": ["Corda", "Barra Reta", "Triângulo"],
                "Extensão Lombar": ["Banco (Hiperextensão)", "Máquina", "Good Morning (Bom dia)"]
            },
            "Ombros": {
                "Desenvolvimento": ["Barra (Militar em Pé)", "Barra (Sentado)", "Halteres (Sentado)", "Halteres (Em Pé)", "Arnold Press", "Smith (Frente)", "Smith (Nuca)", "Máquina", "Articulado"],
                "Elevação Lateral": ["Halteres (Em Pé)", "Halteres (Sentado)", "Polia (Cabo)", "Máquina", "Unilateral (Inclinado)"],
                "Elevação Frontal": ["Halteres (Martelo)", "Halteres (Pronada)", "Barra", "Corda (Polia)", "Anilha"],
                "Posterior de Ombro": ["Crucifixo Inverso (Halter)", "Voador Inverso (Máquina)", "Face Pull (Polia)", "Crucifixo Inverso (Polia)"],
                "Remada Alta": ["Barra", "Polia", "Halteres"],
                "Encolhimento (Trapézio)": ["Barra", "Halteres", "Smith", "Máquina"]
            },
            "Pernas: Quadríceps": {
                "Agachamento": ["Livre (Barra Costas)", "Frontal (Barra)", "Sumô", "Halter (Goblet)", "Zercher", "Safety Bar"],
                "Agachamento Máquina": ["Smith", "Hack Machine", "V-Squat", "Pêndulo", "Sissy Squat"],
                "Leg Press": ["45 Graus", "Horizontal", "Vertical", "Unilateral"],
                "Cadeira Extensora": ["Bilateral", "Unilateral"],
                "Passada/Afundo": ["Avanço (Caminhando)", "Afundo Estático (Halter)", "Afundo (Smith)", "Agachamento Búlgaro", "Subida no Banco (Step-up)"]
            },
            "Pernas: Adutores": {
                 "Cadeira Adutora": ["Sentado"],
                 "Adução Polia": ["Em Pé"]
            },
            "Pernas: Posteriores": {
                "Mesa Flexora": ["Deitada (Bilateral)", "Deitada (Unilateral)"],
                "Cadeira Flexora": ["Sentada (Bilateral)", "Sentada (Unilateral)"],
                "Flexora em Pé": ["Máquina", "Caneleira"],
                "Stiff": ["Barra", "Halteres", "Smith"],
                "RDL (Romanian Deadlift)": ["Barra", "Halteres"],
                "Nordic Hamstring": ["Peso do Corpo", "Assistido"]
            },
            "Pernas: Glúteos": {
                "Elevação Pélvica": ["Barra Livre", "Máquina", "Smith", "Unilateral", "Halter"],
                "Cadeira Abdutora": ["Tronco Reto", "Tronco Inclinado"],
                "Glúteo Polia (Coice)": ["Perna Estendida", "Perna Flexionada"],
                "Glúteo Máquina": ["Coice", "Vertical"],
                "Caneleira": ["4 Apoios", "Em Pé"]
            },
            "Panturrilhas": {
                "Em Pé": ["Máquina", "Smith", "Livre (Degrau/Halter)", "Unilateral"],
                "Sentado": ["Banco (Gêmeos)", "Máquina", "No Leg Press"],
                "Burrinho": ["Máquina", "Com Parceiro"]
            },
            "Tríceps": {
                "Tríceps Polia (Cabo)": ["Corda", "Barra Reta", "Barra V", "Barra W", "Unilateral (Pegada Inversa)", "Unilateral (Pegada Neutra)"],
                "Tríceps Testa": ["Barra W", "Halteres", "Barra H", "Corda (Polia)"],
                "Tríceps Francês": ["Unilateral (Halter)", "Bilateral (Halter)", "Corda (Polia)", "Barra W (Sentado)"],
                "Supino Fechado": ["Barra", "Smith"],
                "Mergulho": ["Paralelas", "Banco", "Máquina (Graviton)"],
                "Coice": ["Halter", "Polia"]
            },
            "Bíceps": {
                "Rosca Direta": ["Barra Reta", "Barra W", "Polia Baixa (Barra)", "Polia Baixa (Unilateral)"],
                "Rosca na Polia": ["Unilateral (Polia Baixa)", "Bayeisan Curl (Polia)", "Corda (Martelo Polia)"],
                "Rosca Alternada": ["Halteres (Em pé)", "Halteres (Banco Inclinado 45º)", "Giro de Punho"],
                "Rosca Martelo": ["Halteres", "Corda (Polia)", "Barra H"],
                "Rosca Scott": ["Barra W", "Máquina", "Unilateral (Halter)"],
                "Rosca Concentrada": ["Halter", "Polia"],
                "Rosca Aranha": ["Barra W", "Halteres"],
                "Rosca 21": ["Barra W", "Barra Reta"]
            },
            "Antebraço": {
                "Flexão de Punho": ["Barra", "Halter", "Polia"],
                "Extensão de Punho": ["Barra", "Halter", "Polia"],
                "Rosca Inversa": ["Barra W", "Barra Reta", "Polia"]
            },
            "Abdômen / Core": {
                "Reto Abdominal": ["Supra (Chão)", "Supra (Máquina)", "Crunch (Polia/Corda)", "Banco Declinado"],
                "Infra": ["Elevação de Pernas (Chão)", "Elevação de Pernas (Barra)", "Tesoura"],
                "Oblíquos": ["Giro Russo (Russian Twist)", "Flexão Lateral de Tronco (Halter)", "Lenhador (Polia)"],
                "Isometria": ["Prancha Frontal", "Prancha Lateral", "Stomach Vacuum", "Roda Abdominal"]
            },
            "Cardio": {
                "Máquinas": ["Esteira (Caminhada)", "Esteira (Corrida)", "Bike Ergométrica", "Bike Spinning", "Elíptico", "Escada (Simulador)", "Remo Indoor"],
                "Livre": ["Pular Corda", "Corrida na Rua", "Caminhada", "Polichinelos", "Burpees"]
            }
        };

        const StorageService = {
            KEY_LOGS: 'registro_prs_logs_v2',
            KEY_API: 'registro_prs_api_key',
            getLogs: () => {
                try {
                    const data = localStorage.getItem(StorageService.KEY_LOGS);
                    return data ? JSON.parse(data).sort((a, b) => b.createdAt - a.createdAt) : [];
                } catch (e) { console.error("Erro ao ler logs", e); return []; }
            },
            saveLog: (log) => {
                const logs = StorageService.getLogs();
                const newLogs = [log, ...logs];
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return newLogs;
            },
            updateLog: (updatedLog) => {
                const logs = StorageService.getLogs();
                const index = logs.findIndex(l => l.id === updatedLog.id);
                if (index !== -1) {
                    logs[index] = updatedLog;
                    localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(logs));
                    return logs;
                }
                return logs;
            },
            deleteLog: (timestamp) => {
                const logs = StorageService.getLogs();
                const newLogs = logs.filter(l => l.createdAt !== timestamp);
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return newLogs;
            },
            importLogs: (newLogs) => {
                if (!Array.isArray(newLogs)) return false;
                localStorage.setItem(StorageService.KEY_LOGS, JSON.stringify(newLogs));
                return true;
            },
            getApiKey: () => localStorage.getItem(StorageService.KEY_API) || DEFAULT_API_KEY,
            setApiKey: (key) => localStorage.setItem(StorageService.KEY_API, key)
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [activeTab, setActiveTab] = useState('metrics');
            const [logs, setLogs] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [apiKey, setApiKey] = useState('');

            useEffect(() => {
                const storedKey = StorageService.getApiKey();
                setLogs(StorageService.getLogs());
                // Define a chave: se tiver no storage usa ela, se não, usa a DEFAULT
                setApiKey(storedKey || DEFAULT_API_KEY);
            }, []);

            const handleSaveKey = () => {
                StorageService.setApiKey(apiKey);
                setShowSettings(false);
                alert("Chave salva! Recarregue a página se necessário.");
            };

            const handleDelete = (timestamp) => {
                if(confirm("Tem certeza que deseja apagar este registro?")) {
                    setLogs(StorageService.deleteLog(timestamp));
                }
            };

            const handleUpdate = (updatedLog) => {
                const newLogs = StorageService.updateLog(updatedLog);
                setLogs(newLogs.sort((a, b) => b.createdAt - a.createdAt));
            };

            const refreshLogs = () => setLogs(StorageService.getLogs());

            // Função unificada para garantir que temos uma chave
            const resolveApiKey = () => {
                return apiKey || DEFAULT_API_KEY;
            };

            return (
                <div className="min-h-screen pb-24 md:pb-0 font-sans text-gray-800 bg-gray-100 flex flex-col">
                    <header className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-30 pt-[env(safe-area-inset-top)]">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center space-x-2">
                                <div className="bg-indigo-500 p-1.5 rounded-lg shadow-lg shadow-indigo-500/30">
                                    <Trophy className="h-5 w-5 text-yellow-300" fill="#fcd34d" strokeWidth={1.5}/>
                                </div>
                                <h1 className="text-lg font-black tracking-tight italic">REGISTRO <span className="text-indigo-400">PR's+</span></h1>
                            </div>
                            <button onClick={() => setShowSettings(true)} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition active:scale-95">
                                <Settings className="w-5 h-5" />
                            </button>
                        </div>
                    </header>

                    {showSettings && (
                        <SettingsModal 
                            apiKey={apiKey} 
                            setApiKey={setApiKey} 
                            onSave={handleSaveKey} 
                            onClose={() => setShowSettings(false)}
                            logs={logs}
                            onImportSuccess={refreshLogs}
                        />
                    )}

                    <main className="max-w-4xl mx-auto p-4 flex-grow w-full">
                        {activeTab === 'log' ? (
                            <LoggerSection onUpdateLogs={(newLogs) => setLogs(newLogs)} apiKey={resolveApiKey()} />
                        ) : activeTab === 'planner' ? (
                            <PlannerSection apiKey={resolveApiKey()} />
                        ) : activeTab === 'nutrition' ? (
                            <NutritionSection apiKey={resolveApiKey()} />
                        ) : (
                            <MetricsSection logs={logs} apiKey={resolveApiKey()} onDelete={handleDelete} onUpdate={handleUpdate} />
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 pb-[env(safe-area-inset-bottom)] md:hidden shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-20">
                        <NavBtn icon={BarChart2} label="Dash" active={activeTab === 'metrics'} onClick={() => setActiveTab('metrics')} />
                        <NavBtn icon={Plus} label="Registrar" active={activeTab === 'log'} onClick={() => setActiveTab('log')} />
                        <NavBtn icon={Map} label="Treino" active={activeTab === 'planner'} onClick={() => setActiveTab('planner')} />
                        <NavBtn icon={Utensils} label="Nutri AI" active={activeTab === 'nutrition'} onClick={() => setActiveTab('nutrition')} />
                    </nav>

                    <div className="hidden md:flex justify-center mt-6 space-x-4 mb-10">
                        <DesktopBtn label="Dashboard" active={activeTab === 'metrics'} onClick={() => setActiveTab('metrics')} />
                        <DesktopBtn label="Registrar PR" active={activeTab === 'log'} onClick={() => setActiveTab('log')} />
                        <DesktopBtn label="Treino IA" active={activeTab === 'planner'} onClick={() => setActiveTab('planner')} />
                        <DesktopBtn label="Nutri AI" active={activeTab === 'nutrition'} onClick={() => setActiveTab('nutrition')} />
                    </div>
                </div>
            );
        }

        const NavBtn = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center p-2 rounded-xl transition w-full ${active ? 'text-indigo-600 bg-indigo-50' : 'text-gray-400 hover:text-gray-600'}`}>
                <Icon className={`w-6 h-6 mb-1 ${active ? 'fill-current' : ''}`} strokeWidth={active ? 2.5 : 2} />
                <span className="text-[10px] font-bold">{label}</span>
            </button>
        );
        const DesktopBtn = ({ label, active, onClick }) => (
            <button onClick={onClick} className={`px-6 py-2 rounded-full font-bold text-sm transition transform hover:scale-105 ${active ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-gray-600 shadow border hover:bg-gray-50'}`}>{label}</button>
        );

        // --- MODAL DE CONFIGURAÇÕES ---
        function SettingsModal({ apiKey, setApiKey, onSave, onClose, logs, onImportSuccess }) {
            const fileInputRef = useRef(null);

            const handleExport = () => {
                const dataStr = JSON.stringify(logs, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_pr_tracker_${getLocalTodayDate()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedLogs = JSON.parse(e.target.result);
                        if (Array.isArray(importedLogs)) {
                            if (confirm(`Encontrados ${importedLogs.length} registros.\n\nISSO SUBSTITUIRÁ SEUS DADOS ATUAIS.\n\nDeseja continuar?`)) {
                                StorageService.importLogs(importedLogs);
                                onImportSuccess();
                                alert("Dados restaurados com sucesso!");
                                onClose();
                            }
                        } else {
                            alert("Arquivo JSON inválido.");
                        }
                    } catch (err) { alert("Erro ao ler arquivo."); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-fade backdrop-blur-sm">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl overflow-y-auto max-h-[90vh]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold flex items-center text-slate-800"><Settings className="w-5 h-5 mr-2"/> Configurações</h3>
                            <button onClick={onClose} className="p-1 rounded-full hover:bg-gray-100"><X className="w-5 h-5"/></button>
                        </div>
                        
                        <div className="mb-6">
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-2 tracking-wider">Chave da API Gemini</h4>
                            <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Cole sua API Key aqui..." className="w-full p-3 border border-gray-200 rounded-xl mb-2 text-sm font-mono bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none" />
                            <p className="text-[10px] text-gray-400 mb-2">Deixe em branco para usar a chave padrão do sistema.</p>
                            <button onClick={onSave} className="w-full bg-indigo-600 text-white font-bold py-2 rounded-xl text-sm hover:bg-indigo-700 active:scale-95 transition">Salvar Preferência</button>
                        </div>

                        <hr className="border-gray-100 my-4" />

                        <div>
                            <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider">Gerenciar Dados</h4>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={handleExport} className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-indigo-300 transition group bg-white">
                                    <Download className="w-6 h-6 text-indigo-500 mb-2 group-hover:scale-110 transition"/>
                                    <span className="text-sm font-bold text-gray-700">Exportar</span>
                                    <span className="text-[10px] text-gray-400">Backup JSON</span>
                                </button>
                                <button onClick={() => fileInputRef.current.click()} className="flex flex-col items-center justify-center p-4 border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-orange-300 transition group bg-white">
                                    <Upload className="w-6 h-6 text-orange-500 mb-2 group-hover:scale-110 transition"/>
                                    <span className="text-sm font-bold text-gray-700">Restaurar</span>
                                    <span className="text-[10px] text-gray-400">Ler JSON</span>
                                </button>
                                <input type="file" accept=".json" ref={fileInputRef} style={{display: 'none'}} onChange={handleFileChange} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD (METRICS) ---
        function MetricsSection({ logs, apiKey, onDelete, onUpdate }) {
            const [view, setView] = useState('dashboard');
            const [analysis, setAnalysis] = useState('');
            const [loading, setLoading] = useState(false);
            const [editingLog, setEditingLog] = useState(null);

            const heatmapData = useMemo(() => {
                const days = [];
                const today = new Date();
                const offset = today.getTimezoneOffset() * 60000;
                
                for (let i = 27; i >= 0; i--) {
                    const d = new Date(today.getTime() - (i * 86400000) - offset);
                    const dateStr = d.toISOString().split('T')[0];
                    const count = logs.filter(l => l.workoutDate === dateStr).length;
                    days.push({ date: dateStr, count, dayNum: d.getDate() });
                }
                return days;
            }, [logs]);

            const muscleStats = useMemo(() => {
                const stats = {};
                let total = 0;
                logs.forEach(l => {
                    stats[l.muscleGroup] = (stats[l.muscleGroup] || 0) + 1;
                    total++;
                });
                return Object.entries(stats)
                    .map(([name, count]) => ({ name, count, percent: total ? (count/total)*100 : 0 }))
                    .sort((a,b) => b.count - a.count);
            }, [logs]);

            const prs = useMemo(() => {
                const map = {};
                logs.forEach(l => {
                    const key = `${l.exercise} ${l.variation}`;
                    if(!map[key] || l.weight > map[key].maxW) {
                         map[key] = { maxW: l.weight, maxR: l.reps, date: l.dateString, group: l.muscleGroup }; 
                    }
                });
                return Object.entries(map).slice(0, 6);
            }, [logs]);

            const groupedHistory = useMemo(() => {
                const groups = {};
                logs.forEach(l => {
                    if(!groups[l.dateString]) groups[l.dateString] = [];
                    groups[l.dateString].push(l);
                });
                return Object.entries(groups).sort((a,b) => {
                    const dateA = a[0].split('/').reverse().join('');
                    const dateB = b[0].split('/').reverse().join('');
                    return dateB.localeCompare(dateA);
                });
            }, [logs]);

            const analyze = async () => {
                if(!apiKey) { alert("API Key ausente."); return; }

                setLoading(true);
                try {
                    const history = logs.slice(0, 30).map(l => `${l.dateString}: ${l.exercise} (${l.weight}kg x ${l.reps})`).join('\n');
                    const prompt = `Aja como um treinador. Analise este histórico de treino recente e me dê um feedback curto e motivador. Histórico:\n${history}`;
                    
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (!res.ok) {
                         const errData = await res.json();
                         throw new Error(errData.error?.message || `Erro HTTP ${res.status}`);
                    }
                    
                    const data = await res.json();
                    setAnalysis(data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro na análise. Sem resposta.");
                } catch(e) { 
                    setAnalysis(`Erro na IA: ${e.message}. Verifique restrições de domínio da API Key.`); 
                }
                setLoading(false);
            };

            return (
                <div className="animate-slide space-y-6">
                    <div className="flex bg-gray-200 p-1 rounded-xl">
                        <button onClick={() => setView('dashboard')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${view==='dashboard'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Visão Geral</button>
                        <button onClick={() => setView('history')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${view==='history'?'bg-white shadow text-indigo-600':'text-gray-500'}`}>Histórico</button>
                    </div>

                    {view === 'dashboard' ? (
                        <>
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center text-sm uppercase tracking-wider"><Flame className="w-4 h-4 mr-2 text-orange-500" fill="currentColor"/> Constância (30 dias)</h3>
                                <div className="grid grid-cols-7 gap-2">
                                    {heatmapData.map((d, i) => (
                                        <div key={i} className={`aspect-square rounded-md flex items-center justify-center text-[10px] font-bold transition-all hover:scale-110 ${d.count > 0 ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'bg-gray-100 text-gray-300'}`}>
                                            {d.dayNum}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-3xl p-5 text-white shadow-lg relative overflow-hidden">
                                <Brain className="absolute right-0 top-0 w-24 h-24 text-white opacity-10 -mr-6 -mt-6"/>
                                <div className="relative z-10">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold flex items-center"><Sparkles className="w-4 h-4 mr-2 text-yellow-300"/> Coach IA</h3>
                                        <button onClick={analyze} disabled={loading} className="text-[10px] bg-white/20 px-3 py-1.5 rounded-full hover:bg-white/30 font-bold transition disabled:opacity-50">
                                            {loading ? "Pensando..." : "Analisar Progresso"}
                                        </button>
                                    </div>
                                    <div className="bg-black/20 p-3 rounded-xl min-h-[60px]">
                                        {analysis ? <div className="text-xs whitespace-pre-wrap leading-relaxed">{analysis}</div> : <p className="text-xs opacity-70 italic">Toque em analisar para receber feedback.</p>}
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                                <h3 className="font-bold text-gray-800 mb-4 flex items-center text-sm uppercase tracking-wider"><LayoutGrid className="w-4 h-4 mr-2 text-indigo-500"/> Foco Muscular</h3>
                                <div className="space-y-3">
                                    {muscleStats.slice(0, 5).map((s) => (
                                        <div key={s.name}>
                                            <div className="flex justify-between text-xs font-bold mb-1">
                                                <span className="text-gray-700">{s.name}</span>
                                                <span className="text-indigo-500">{Math.round(s.percent)}%</span>
                                            </div>
                                            <div className="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                                <div className="h-full bg-indigo-500 rounded-full transition-all duration-1000" style={{width: `${s.percent}%`}}></div>
                                            </div>
                                        </div>
                                    ))}
                                    {muscleStats.length === 0 && <p className="text-center text-xs text-gray-400">Nenhum dado registrado.</p>}
                                </div>
                            </div>
                            <div>
                                <h3 className="font-bold text-gray-800 mb-3 ml-1 text-sm uppercase tracking-wider">Top Recordes</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {prs.map(([name, data]) => (
                                        <div key={name} className="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-between hover:border-indigo-100 transition">
                                            <div>
                                                <span className="text-[9px] font-bold text-indigo-400 uppercase tracking-wide bg-indigo-50 px-1.5 py-0.5 rounded">{data.group}</span>
                                                <h4 className="font-bold text-gray-800 text-xs leading-tight mt-2 mb-2 line-clamp-2">{name}</h4>
                                            </div>
                                            <div className="flex items-end justify-between border-t border-gray-50 pt-2 mt-1">
                                                <div className="text-xl font-black text-gray-900">{data.maxW}<span className="text-xs font-normal text-gray-400 ml-0.5">kg</span></div>
                                                <div className="text-[10px] text-gray-400">{data.maxR} reps</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    ) : (
                        <div className="space-y-8 pb-10">
                            {groupedHistory.map(([date, items]) => (
                                <div key={date} className="relative pl-6 border-l-2 border-indigo-100">
                                    <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-indigo-500 border-4 border-white shadow-sm"></div>
                                    <h3 className="font-bold text-gray-800 mb-4 text-lg">{date}</h3>
                                    <div className="space-y-3">
                                        {items.map(log => (
                                            <div key={log.id} className="bg-white p-3.5 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center group active:scale-[0.99] transition">
                                                <div className="flex-1 pr-2">
                                                    <div className="font-bold text-gray-700 text-sm">{log.exercise}</div>
                                                    <div className="text-xs text-gray-400">{log.variation}</div>
                                                </div>
                                                <div className="flex items-center space-x-3">
                                                    <div className="text-right">
                                                        <div className="font-bold text-indigo-600 text-base">{log.weight}kg</div>
                                                        <div className="text-[10px] text-gray-400">{log.reps} reps</div>
                                                    </div>
                                                    <div className="flex flex-col space-y-1">
                                                        <button onClick={()=>setEditingLog(log)} className="p-1.5 bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-100"><Pencil className="w-3 h-3"/></button>
                                                        <button onClick={()=>onDelete(log.createdAt)} className="p-1.5 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><Trash2 className="w-3 h-3"/></button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            {groupedHistory.length === 0 && <div className="text-center text-gray-400 py-10 italic">Nenhum treino registrado ainda.</div>}
                        </div>
                    )}
                    {editingLog && (
                        <EditLogModal log={editingLog} onClose={() => setEditingLog(null)} onSave={(updatedLog) => { onUpdate(updatedLog); setEditingLog(null); }} />
                    )}
                </div>
            );
        }

        // --- EDIT MODAL ---
        function EditLogModal({ log, onClose, onSave }) {
            const [weight, setWeight] = useState(log.weight);
            const [reps, setReps] = useState(log.reps);
            const [date, setDate] = useState(log.workoutDate);
            const [group, setGroup] = useState(log.muscleGroup);
            const [type, setType] = useState(log.exercise);
            const [variation, setVariation] = useState(log.variation);

            useEffect(() => {
                if (group && EXERCISE_CATALOG[group] && !EXERCISE_CATALOG[group][type]) { setType(''); setVariation(''); }
            }, [group]);
            useEffect(() => {
                 if (group && type && EXERCISE_CATALOG[group] && EXERCISE_CATALOG[group][type] && !EXERCISE_CATALOG[group][type].includes(variation)) { setVariation(''); }
            }, [type]);
            const handleSave = () => {
                const [y, m, d] = date.split('-');
                onSave({
                    ...log, weight: parseFloat(weight), reps: parseInt(reps), workoutDate: date, dateString: `${d}/${m}/${y}`, muscleGroup: group, exercise: type, variation: variation
                });
            };
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade backdrop-blur-sm">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-md shadow-2xl relative">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold flex items-center text-indigo-600"><Pencil className="w-5 h-5 mr-2"/> Editar</h3>
                            <button onClick={onClose}><X className="w-5 h-5 text-gray-400"/></button>
                        </div>
                        <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-1">
                            <div>
                                <label className="text-[10px] font-bold text-gray-400 uppercase">Data</label>
                                <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-gray-50 p-3 rounded-xl font-bold outline-none text-gray-700"/>
                            </div>
                            <Select label="Grupo" value={group} onChange={e=>setGroup(e.target.value)} options={Object.keys(EXERCISE_CATALOG)} />
                            {group && <Select label="Exercício" value={type} onChange={e=>setType(e.target.value)} options={Object.keys(EXERCISE_CATALOG[group]) || []} />}
                            {type && group && EXERCISE_CATALOG[group][type] && (
                                <div className="relative">
                                    <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Variação</label>
                                    <select value={variation} onChange={e=>setVariation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-sm text-gray-700">
                                        <option value="" disabled>Selecione...</option>
                                        {EXERCISE_CATALOG[group][type].map(v=><option key={v} value={v}>{v}</option>)}
                                    </select>
                                    <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                                </div>
                            )}
                            <div className="grid grid-cols-2 gap-3">
                                <Input label="Carga (kg)" type="number" value={weight} onChange={e=>setWeight(e.target.value)} />
                                <Input label="Reps" type="number" value={reps} onChange={e=>setReps(e.target.value)} />
                            </div>
                        </div>
                        <button onClick={handleSave} className="w-full mt-6 py-3 bg-indigo-600 font-bold rounded-xl text-white shadow-lg shadow-indigo-200 active:scale-95 transition">Salvar Alterações</button>
                    </div>
                </div>
            );
        }

        // --- LOGGER (REGISTRO) ---
        function LoggerSection({ onUpdateLogs, apiKey }) {
            const [date, setDate] = useState(getLocalTodayDate());
            const [group, setGroup] = useState('');
            const [type, setType] = useState('');
            const [variation, setVariation] = useState('');
            const [weight, setWeight] = useState('');
            const [reps, setReps] = useState('');
            const [showTips, setShowTips] = useState(false);
            const [tipLoading, setTipLoading] = useState(false);
            const [tipContent, setTipContent] = useState('');
            
            useEffect(() => { setType(''); setVariation(''); setTipContent(''); setShowTips(false); }, [group]);
            useEffect(() => { 
                if(group && type && EXERCISE_CATALOG[group][type]) {
                    setVariation(EXERCISE_CATALOG[group][type][0] || '');
                }
                setTipContent(''); setShowTips(false);
            }, [type]);

            const fetchTips = async () => {
                if(!apiKey) { alert("API Key ausente."); return; }
                
                setShowTips(true);
                if(tipContent) return; // Já carregou

                setTipLoading(true);
                try {
                    const prompt = `Explique de forma resumida e direta (em bullet points) a forma correta de executar o exercício: ${type} (${variation}). Dê 2 dicas de segurança.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (!res.ok) {
                         const errData = await res.json();
                         throw new Error(errData.error?.message || `Erro HTTP ${res.status}`);
                    }

                    const data = await res.json();
                    setTipContent(data.candidates?.[0]?.content?.parts?.[0]?.text || "Não foi possível carregar dicas.");
                } catch(e) { setTipContent(`Erro ao carregar dicas: ${e.message}`); }
                setTipLoading(false);
            };

            const handleSave = (e) => {
                e.preventDefault();
                const [y, m, d] = date.split('-');
                const log = {
                    id: Date.now(), muscleGroup: group, exercise: type, variation, weight: parseFloat(weight), reps: parseInt(reps),
                    workoutDate: date, dateString: `${d}/${m}/${y}`, createdAt: Date.now()
                };
                onUpdateLogs(StorageService.saveLog(log));
                setWeight(''); setReps('');
            };

            return (
                <div className="animate-slide bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center"><Plus className="w-5 h-5 mr-2 text-indigo-500"/> Novo Registro</h2>
                    <form onSubmit={handleSave} className="space-y-4">
                        <div className="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <label className="text-[10px] font-bold text-gray-400 uppercase">Data do Treino</label>
                            <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-transparent font-bold text-gray-800 outline-none mt-1"/>
                        </div>
                        <Select label="Grupo Muscular" value={group} onChange={e=>setGroup(e.target.value)} options={Object.keys(EXERCISE_CATALOG)} />
                        {group && <Select label="Exercício" value={type} onChange={e=>setType(e.target.value)} options={Object.keys(EXERCISE_CATALOG[group])} />}
                        {type && (
                             <div className="relative">
                                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Variação</label>
                                <select value={variation} onChange={e=>setVariation(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                                    {EXERCISE_CATALOG[group][type].map(v=><option key={v} value={v}>{v}</option>)}
                                </select>
                                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
                            </div>
                        )}

                        {/* GEMINI TIP BUTTON */}
                        {type && variation && (
                            <div className="mt-2">
                                <button type="button" onClick={fetchTips} className="text-xs flex items-center text-indigo-500 font-bold hover:text-indigo-700 transition">
                                    <Sparkles className="w-3 h-3 mr-1" /> {showTips ? 'Esconder Dicas' : 'Como fazer? (IA)'}
                                </button>
                                {showTips && (
                                    <div className="mt-2 p-3 bg-indigo-50 rounded-xl text-xs text-indigo-900 border border-indigo-100 leading-relaxed animate-fade">
                                        {tipLoading ? "Consultando coach..." : <div className="whitespace-pre-wrap">{tipContent}</div>}
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-3 pt-2">
                            <Input label="Carga (kg)" type="number" value={weight} onChange={e=>setWeight(e.target.value)} placeholder="0" />
                            <Input label="Reps" type="number" value={reps} onChange={e=>setReps(e.target.value)} placeholder="0" />
                        </div>
                        <button disabled={!variation || !weight} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 disabled:opacity-50 disabled:shadow-none active:scale-95 transition mt-4">
                            CONFIRMAR SÉRIE
                        </button>
                    </form>
                </div>
            );
        }

        // --- PLANNER (IA) ---
        function PlannerSection({ apiKey }) {
            const [goal, setGoal] = useState('');
            const [plan, setPlan] = useState('');
            const [loading, setLoading] = useState(false);
            const handlePlan = async (e) => {
                e.preventDefault();
                if(!apiKey) { alert("API Key ausente."); return; }

                setLoading(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Crie um treino detalhado (Markdown simples) baseado nisto: "${goal}". Seja direto.` }] }] })
                    });
                    
                    if (!res.ok) {
                         const errData = await res.json();
                         throw new Error(errData.error?.message || `Erro HTTP ${res.status}`);
                    }

                    const data = await res.json();
                    setPlan(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch(e) { alert(`Erro IA: ${e.message}`); }
                setLoading(false);
            };
            return (
                <div className="animate-slide space-y-4">
                    <div className="bg-gradient-to-br from-teal-500 to-emerald-600 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden">
                        <Zap className="absolute right-0 top-0 w-32 h-32 opacity-10 -mr-6 -mt-6"/>
                        <h2 className="text-xl font-bold mb-2 flex items-center relative z-10"><Map className="w-5 h-5 mr-2"/> Gerador de Treino</h2>
                        <textarea value={goal} onChange={e=>setGoal(e.target.value)} placeholder="Ex: Peito e Tríceps foco em força, tenho apenas halteres..." className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 outline-none h-28 text-sm relative z-10"></textarea>
                        <button onClick={handlePlan} disabled={loading} className="mt-3 w-full bg-white text-teal-700 font-bold py-3 rounded-xl text-sm shadow-lg relative z-10 hover:bg-teal-50 transition">
                            {loading ? "Criando Estratégia..." : "Gerar Treino com IA"}
                        </button>
                    </div>
                    {plan && (
                        <div className="bg-white p-6 rounded-3xl shadow-sm prose prose-sm max-w-none animate-fade border border-gray-100">
                             <div className="whitespace-pre-wrap text-gray-700 leading-relaxed">
                                {plan.replace(/\*\*/g, '').split('\n').map((line, i) => (
                                    <p key={i} className={`${line.startsWith('#') ? 'font-bold text-teal-700 text-lg mt-4 border-b border-gray-100 pb-1' : 'mb-2'}`}>
                                        {line.replace(/^#+\s/, '')}
                                    </p>
                                ))}
                             </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- NUTRITION (IA) ---
        function NutritionSection({ apiKey }) {
            const [query, setQuery] = useState('');
            const [response, setResponse] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAskNutri = async (e) => {
                e.preventDefault();
                if(!apiKey) { alert("API Key ausente."); return; }

                setLoading(true);
                try {
                    const prompt = `Aja como um nutricionista esportivo. Responda a seguinte dúvida sobre alimentação de forma prática e saudável: "${query}". Use Markdown simples.`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (!res.ok) {
                         const errData = await res.json();
                         throw new Error(errData.error?.message || `Erro HTTP ${res.status}`);
                    }

                    const data = await res.json();
                    setResponse(data.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch(e) { alert(`Erro IA: ${e.message}`); }
                setLoading(false);
            };

            return (
                <div className="animate-slide space-y-4">
                    <div className="bg-gradient-to-br from-orange-400 to-red-500 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden">
                        <ChefHat className="absolute right-0 top-0 w-32 h-32 opacity-10 -mr-6 -mt-6"/>
                        <h2 className="text-xl font-bold mb-2 flex items-center relative z-10"><Utensils className="w-5 h-5 mr-2"/> Nutri AI</h2>
                        <textarea value={query} onChange={e=>setQuery(e.target.value)} placeholder="Ex: O que comer pós-treino de perna? Tenho ovos e batata..." className="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 outline-none h-28 text-sm relative z-10"></textarea>
                        <button onClick={handleAskNutri} disabled={loading} className="mt-3 w-full bg-white text-orange-600 font-bold py-3 rounded-xl text-sm shadow-lg relative z-10 hover:bg-orange-50 transition">
                            {loading ? "Consultando Nutricionista..." : "Pedir Sugestão"}
                        </button>
                    </div>
                    {response && (
                        <div className="bg-white p-6 rounded-3xl shadow-sm prose prose-sm max-w-none animate-fade border border-gray-100">
                             <div className="whitespace-pre-wrap text-gray-700 leading-relaxed">
                                {response.replace(/\*\*/g, '').split('\n').map((line, i) => (
                                    <p key={i} className={`${line.startsWith('#') ? 'font-bold text-orange-600 text-lg mt-4 border-b border-gray-100 pb-1' : 'mb-2'}`}>
                                        {line.replace(/^#+\s/, '')}
                                    </p>
                                ))}
                             </div>
                        </div>
                    )}
                </div>
            );
        }

        const Select = ({ label, value, onChange, options }) => (
            <div className="relative">
                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">{label}</label>
                <select value={value} onChange={onChange} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold outline-none appearance-none text-gray-700 text-sm">
                    <option value="" disabled>Selecione...</option>
                    {options.sort().map(o=><option key={o} value={o}>{o}</option>)}
                </select>
                <ChevronDown className="absolute right-3 top-8 text-gray-400 w-4 h-4 pointer-events-none"/>
            </div>
        );
        const Input = ({ label, ...props }) => (
            <div>
                <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">{label}</label>
                <input {...props} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-center font-bold text-lg outline-none focus:ring-2 focus:ring-indigo-200 transition text-gray-800" />
            </div>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
